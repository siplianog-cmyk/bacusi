<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jogo de Sobreviv√™ncia JS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    /* Estilos globais */
    html, body {
        margin: 0; padding: 0;
        width: 100vw; height: 100vh;
        overflow: hidden;
        background: #222;
        font-family: 'Segoe UI', Arial, sans-serif;
        background: linear-gradient(120deg, #2b5876 0%, #4e4376 100%);
        touch-action: none;
        color: #fff;
    }
    
    /* Telas de Menu e In√≠cio */
    .overlay-menu {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(18, 18, 30, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200;
        text-align: center;
        backdrop-filter: blur(8px);
    }
    .overlay-menu h1 {
        font-size: 3em;
        text-shadow: 2px 2px 12px #000;
        color: #ffe066;
    }
    .overlay-menu button, .overlay-menu input[type="range"], .overlay-menu select {
        padding: 12px 36px;
        font-size: 1.5em;
        border-radius: 12px;
        border: none;
        background: #ffe066;
        color: #222;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        transition: background 0.2s;
        margin-top: 24px;
        width: 80%;
        max-width: 300px;
    }
    .overlay-menu button:hover { background: #fff176; }
    
    /* Rolagem para o menu de op√ß√µes */
    .scrollable-content {
        overflow-y: auto;
        max-height: 80vh;
        padding: 20px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    /* HUD */
    #hud-panel {
      position: absolute;
      top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(40,40,60,0.85);
      border-radius: 12px;
      box-shadow: 0 4px 16px #000a;
      padding: 6px 16px 4px 16px;
      color: #fff;
      font-size: 0.8em;
      text-align: left;
      text-shadow: 1px 1px 4px #000;
      z-index: 10;
      min-width: 280px;
      max-width: 90vw;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    /* Hotbar estilo Minecraft */
    #hotbar {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 10;
        user-select: none;
    }
    .slot {
        width: 50px; height: 50px;
        background: rgba(30,30,40,0.8);
        border: 3px solid #444;
        border-radius: 10px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        transition: transform 0.1s, border-color 0.1s;
    }
    .slot.active {
        border-color: #ffe066;
        transform: scale(1.1);
        box-shadow: 0 0 12px rgba(255, 224, 102, 0.7);
    }
    .item-count {
        position: absolute;
        bottom: 2px; right: 4px;
        font-size: 0.7em;
        text-shadow: 1px 1px 2px #000;
    }
    
    /* Bot√µes flutuantes para mobile */
    #action-buttons {
        position: absolute;
        right: 10px;
        bottom: 100px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 100;
    }
    #action-buttons button {
        width: 60px; height: 60px;
        border-radius: 50%;
        border: none;
        background: rgba(255,255,255,.3);
        color: #000;
        font-size: 1.6em;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    #options-btn {
        position: absolute;
        top: 15px; right: 15px;
        width: 40px; height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6em;
        cursor: pointer;
        z-index: 20;
    }
    
    /* Visuais */
    .heart { color: #ff5252; font-size: 1em; text-shadow: 0 0 4px #fff, 0 0 1px #f00; }
    .armor { color: #b0c4de; font-size: 1em; text-shadow: 0 0 4px #fff, 0 0 1px #09f; }
    #pauseOverlay {
      position: absolute;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(20,20,40,0.8);
      z-index: 99;
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 3em;
      font-weight: bold;
      text-shadow: 2px 2px 12px #000;
      pointer-events: none;
    }
    canvas {
      display: block;
      position: absolute;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: transparent;
      border: none;
      margin: 0;
      z-index: 1;
    }

    /* Joystick */
    #joystick-area {
        position: absolute;
        bottom: 40px; left: 40px;
        width: 100px; height: 100px;
        display: block;
        touch-action: none;
        z-index: 100;
    }
    #joystick-base {
        width: 100%; height: 100%;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        position: relative;
    }
    #joystick-stick {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 50px; height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
    }
    .option-label {
        font-size: 1em;
        margin-top: 16px;
    }
  </style>
</head>
<body>
  <div id="start-menu" class="overlay-menu">
      <h1>Jogo de Sobreviv√™ncia</h1>
      <p>Escolha sua cor:</p>
      <input type="color" id="color-picker" value="#00e6ff">
      <button id="btn-start">Come√ßar</button>
  </div>
  
  <div id="options-menu" class="overlay-menu" style="display: none;">
      <div class="scrollable-content">
          <h1>Op√ß√µes</h1>
          <p class="option-label">Volume do Jogo:</p>
          <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5">
          <p class="option-label">Fundo do Jogo:</p>
          <select id="background-select" style="font-size:1.2em; padding:8px; margin-top:8px;">
            <option value="dynamic">Din√¢mico</option>
            <option value="beta">Vers√£o Beta</option>
          </select>
          <button id="btn-game-options">Op√ß√µes de Jogo</button>
          <button id="btn-resume">Continuar</button>
      </div>
  </div>
  
  <div id="game-options-menu" class="overlay-menu" style="display: none;">
      <div class="scrollable-content">
          <h1>Configura√ß√µes de Jogo</h1>
          <p class="option-label">Tamanho da HUD:</p>
          <input type="range" id="hud-size-slider" min="0.5" max="2" step="0.1" value="1">
          <p class="option-label">Tamanho dos Bot√µes:</p>
          <input type="range" id="btn-size-slider" min="0.5" max="2" step="0.1" value="1.2">
          <p class="option-label">Tamanho do Joystick:</p>
          <input type="range" id="joystick-size-slider" min="0.5" max="2" step="0.1" value="1.2">
          <p class="option-label">Posi√ß√£o do Joystick (Horizontal):</p>
          <input type="range" id="joystick-x-slider" min="10" max="90" step="1" value="20">
          <p class="option-label">Posi√ß√£o do Joystick (Vertical):</p>
          <input type="range" id="joystick-y-slider" min="10" max="90" step="1" value="80">
          <p class="option-label">Posi√ß√£o dos Bot√µes (Horizontal):</p>
          <input type="range" id="btn-x-slider" min="10" max="90" step="1" value="85">
          <p class="option-label">Posi√ß√£o dos Bot√µes (Vertical):</p>
          <input type="range" id="btn-y-slider" min="10" max="90" step="1" value="80">
          <button id="btn-back-options">Voltar</button>
      </div>
  </div>

  <div id="game-container">
    <div id="hud-panel">
      <div id="info">
        <span id="timer">0.0</span> s &nbsp;|&nbsp; 
        <span id="dias">Dia 1</span> &nbsp;|&nbsp;
        <span class="heart" id="vida"></span>
        <span class="armor" id="armadura"></span>
      </div>
      <div id="inv"></div>
      <div id="craft"></div>
    </div>
  
    <div id="hotbar"></div>
  
    <canvas id="game"></canvas>
    <div id="pauseOverlay">PAUSADO</div>
  
    <div id="joystick-area">
        <div id="joystick-base">
            <div id="joystick-stick"></div>
        </div>
    </div>
  
    <div id="action-buttons">
        <button id="btn-action">E</button>
        <button id="btn-create">Q</button>
    </div>
    <button id="options-btn">‚öôÔ∏è</button>
    <button id="restart" style="display:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:20;">Recome√ßar</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    const startMenu = document.getElementById('start-menu');
    const optionsMenu = document.getElementById('options-menu');
    const gameOptionsMenu = document.getElementById('game-options-menu');
    const gameContainer = document.getElementById('game-container');
    const btnStart = document.getElementById('btn-start');
    const btnResume = document.getElementById('btn-resume');
    const btnGameOptions = document.getElementById('btn-game-options');
    const btnBackOptions = document.getElementById('btn-back-options');
    const optionsBtn = document.getElementById('options-btn');
    const btnAction = document.getElementById('btn-action');
    const btnCreate = document.getElementById('btn-create');
    const joystickArea = document.getElementById('joystick-area');
    const joystickBase = document.getElementById('joystick-base');
    const joystickStick = document.getElementById('joystick-stick');
    const volumeSlider = document.getElementById('volume-slider');
    const hudSizeSlider = document.getElementById('hud-size-slider');
    const btnSizeSlider = document.getElementById('btn-size-slider');
    const joystickSizeSlider = document.getElementById('joystick-size-slider');
    const joystickXSlider = document.getElementById('joystick-x-slider');
    const joystickYSlider = document.getElementById('joystick-y-slider');
    const btnXSlider = document.getElementById('btn-x-slider');
    const btnYSlider = document.getElementById('btn-y-slider');
    const colorPicker = document.getElementById('color-picker');
    const backgroundSelect = document.getElementById('background-select');

    if (!isMobile) {
        joystickArea.style.display = 'none';
        document.getElementById('action-buttons').style.display = 'none';
    }
    
    const MAPA_LARGURA = 2400;
    const MAPA_ALTURA = 1200;
    let camera = { x: 0, y: 0 };
    let florestaDesbloqueada = false;
    
    const canvas = document.getElementById('game');
    let ctx = null;
    let CAMERA_ZOOM = 1;

    // SONS e M√öSICAS
    const soundUrls = {
      click: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/click.mp3',
      collect: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/collect.mp3',
      attack: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/attack.mp3',
      damage: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/damage.mp3',
      explosion: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/explosion.mp3',
      step: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/step.mp3',
      potion: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/potion.mp3',
      bow: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/bow.mp3',
      mine: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/mine.mp3',
    };

    const musicUrls = [
      'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/music/1.mp3',
      'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/music/2.mp3',
      'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/music/3.mp3',
    ];

    const sounds = {};
    let currentMusic = null;
    let musicIndex = 0;
    
    for (const key in soundUrls) {
        sounds[key] = new Audio(soundUrls[key]);
    }
    
    function playSound(soundName) {
        if (sounds[soundName]) {
            sounds[soundName].volume = volumeSlider.value;
            sounds[soundName].play().catch(e => console.log("Erro ao tocar o som:", e));
        }
    }
    
    function playNextMusic() {
        if (currentMusic) {
            currentMusic.pause();
            currentMusic.currentTime = 0;
        }
        
        musicIndex = (musicIndex + 1) % musicUrls.length;
        currentMusic = new Audio(musicUrls[musicIndex]);
        currentMusic.volume = volumeSlider.value;
        currentMusic.loop = false;
        currentMusic.onended = playNextMusic;
        currentMusic.play().catch(e => console.log("Erro ao tocar m√∫sica:", e));
    }
    
    volumeSlider.addEventListener('input', (e) => {
        for (let sound in sounds) {
            sounds[sound].volume = e.target.value;
        }
        if (currentMusic) {
            currentMusic.volume = e.target.value;
        }
    });

    function initCanvas() {
        if (!canvas) {
            console.error('Canvas element not found.');
            return;
        }
        ctx = canvas.getContext('2d');
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
        if (!canvas) return;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Novo c√°lculo de zoom para mobile
        if (isMobile) {
          const gameAspect = MAPA_LARGURA / MAPA_ALTURA;
          const screenAspect = window.innerWidth / window.innerHeight;
          // Zoom para preencher a tela sem distorcer, focando em manter a √°rea de jogo vis√≠vel
          CAMERA_ZOOM = Math.min(window.innerWidth / MAPA_LARGURA, window.innerHeight / MAPA_ALTURA);
          // Adiciona um pouco de zoom para que o jogador n√£o seja min√∫sculo
          CAMERA_ZOOM = Math.max(0.5, CAMERA_ZOOM);
        } else {
            CAMERA_ZOOM = 1;
        }
    }

    const W = () => canvas.width;
    const H = () => canvas.height;

    const keyboard = {};

    document.addEventListener('keydown', (e) => {
      keyboard[e.key.toLowerCase()] = true;
    });

    document.addEventListener('keyup', (e) => {
      keyboard[e.key.toLowerCase()] = false;
    });

    const timerSpan = document.getElementById('timer');
    const vidaSpan = document.getElementById('vida');
    const armaduraSpan = document.getElementById('armadura');
    const diasSpan = document.getElementById('dias');
    const hudPanel = document.getElementById('hud-panel');
    const hotbarDiv = document.getElementById('hotbar');
    const pauseOverlay = document.getElementById('pauseOverlay');
    const restartBtn = document.getElementById('restart');
    
    const hotbarItens = [
      { id: 'espada', nome: 'Espada', emoji: '‚öîÔ∏è' },
      { id: 'arco', nome: 'Arco', emoji: 'üèπ' },
      { id: 'picareta', nome: 'Picareta', emoji: '‚õèÔ∏è' },
      { id: 'maca', nome: 'Ma√ß√£', emoji: 'üçé' },
      { id: 'tocha', nome: 'Tocha', emoji: 'üî•' },
      { id: 'parede_madeira', nome: 'Parede Madeira', emoji: 'üü´' },
      { id: 'parede_pedra', nome: 'Parede de Pedra', emoji: 'üß±' },
      { id: 'armadilha', nome: 'Armadilha', emoji: 'üï∏Ô∏è' },
      { id: 'mina', nome: 'Mina Explosiva', emoji: 'üí£' },
      { id: 'fogueira', nome: 'Fogueira', emoji: 'üèïÔ∏è' },
      { id: 'tinteiro_magico', nome: 'Tinteiro M√°gico', emoji: 'üñåÔ∏è' },
      { id: 'pocao', nome: 'Po√ß√£o For√ßa', emoji: 'üß™' },
    ];
    let hotbarSelecionado = 0;
    
    function renderHotbar() {
      const hotbarElement = document.getElementById('hotbar');
      if (!hotbarElement) return;
      hotbarElement.innerHTML = '';
      hotbarItens.forEach((item, i) => {
        const slot = document.createElement('div');
        slot.className = `slot`;
        if (hotbarSelecionado === i) {
          slot.classList.add('active');
        }
        slot.innerHTML = `<span>${item.emoji}</span>`;
        if (inventory[item.id] !== undefined) {
          const count = document.createElement('span');
          count.className = 'item-count';
          if (typeof inventory[item.id] === 'boolean') {
            count.textContent = inventory[item.id] ? '‚úîÔ∏è' : '';
          } else {
            count.textContent = inventory[item.id] > 0 ? inventory[item.id] : '';
          }
          slot.appendChild(count);
        }
        slot.onclick = () => { playSound('click'); hotbarSelecionado = i; renderHotbar(); };
        hotbarElement.appendChild(slot);
      });
    }

    let particles = [];
    function resetParticles() {
      particles = [];
      for (let i = 0; i < 32; i++) {
        particles.push({
          x: Math.random() * W(),
          y: Math.random() * H(),
          r: 30 + Math.random() * 60,
          dx: (Math.random() - 0.5) * 0.2,
          dy: (Math.random() - 0.5) * 0.2,
          color: `rgba(${180+Math.random()*60},${200+Math.random()*40},255,${0.08+Math.random()*0.08})`
        });
      }
    }
    resetParticles();
    window.addEventListener('resize', resetParticles);

    let player, enemies, materials, buildings, torches, apples, gems, running, startTime, elapsed, inventory, isDay, dayLength, buildMode, dias, montanhaLiberada, dayTransitionActive, lastDay, paused, mouseWorld = { x: 0, y: 0 };
    let bombs = [];
    let joystickTimeout = null;
    let joystickTouchId = null;
    let arrows = [];

    // Vari√°veis do Multiplayer
    const socket = io();
    const otherPlayers = {};

    function resetGame() {
      player = { 
        x: MAPA_LARGURA / 2, 
        y: MAPA_ALTURA / 2, 
        size: 40, 
        speed: 4, 
        baseSpeed: 4,
        blink: 0, 
        vida: 5, 
        armadura: false, 
        invencivel: 0, 
        id: null,
        color: colorPicker.value,
        attackModifier: 1,
        defenseModifier: 1,
        speedModifier: 1,
        effectTimer: 0
      };
      enemies = [];
      materials = [];
      buildings = [];
      torches = [];
      apples = [];
      gems = [];
      bombs = [];
      running = true;
      paused = false;
      startTime = performance.now();
      elapsed = 0;
      inventory = {
        madeira: 0,
        pedra: 0,
        flechas: 0,
        espada: false,
        picareta: false,
        arco: false,
        tocha: 0,
        fogueira: 0,
        parede_madeira: 0,
        parede_pedra: 0,
        armadilha: 0,
        mina: 0,
        maca: 0,
        armadura: false,
        gema: 0,
        pocao: 0,
        superpicareta: false,
        tinteiro_magico: 0
      };
      
      dayTransitionActive = false;
      isDay = true;
      dayLength = 14;
      buildMode = null;
      dias = 1;
      lastDay = 1;
      montanhaLiberada = false;
      florestaDesbloqueada = false;
      
      renderHotbar();
      updateInventory();
      updateCrafting();
      updateVida();
      resetParticles();
      spawnEnemy();
      spawnMaterials();

      restartBtn.style.display = 'none';

      requestAnimationFrame(gameLoop);
      if (currentMusic) { currentMusic.pause(); }
      playNextMusic();
    }

    function setPause(val) {
      paused = val;
      pauseOverlay.style.display = paused ? 'flex' : 'none';
      if (!paused && !dayTransitionActive) requestAnimationFrame(gameLoop);
      if (currentMusic) {
        if (paused) currentMusic.pause();
        else currentMusic.play();
      }
    }
    
    // Controles e Eventos
    document.addEventListener('keydown', e => {
      const key = e.key.toLowerCase();
      if (paused && key !== 'p' && key !== 'escape') return;
      keyboard[key] = true;
      if (key === 'p' || key === 'escape') { setPause(!paused); }
      if (key >= '1' && key <= '9') { hotbarSelecionado = parseInt(key)-1; renderHotbar(); }
      if (key === '0') { hotbarSelecionado = 9; renderHotbar(); }
      if (key === ' ') attackEnemy();
      if (key === 'q' || key === 'z') { craftSelectedItem(); }
      if (key === 'e' || key === 'x') { usarHotbarAtMouse(); }
    });

    document.addEventListener('keyup', e => {
      keyboard[e.key.toLowerCase()] = false;
    });

    hotbarDiv.addEventListener('wheel', e => {
      e.preventDefault();
      playSound('click');
      if (e.deltaY > 0) hotbarSelecionado = (hotbarSelecionado + 1) % hotbarItens.length;
      else hotbarSelecionado = (hotbarSelecionado + hotbarItens.length - 1) % hotbarItens.length;
      renderHotbar();
    }, {passive:false});

    canvas.addEventListener('mousemove', e=>{
      const rect = canvas.getBoundingClientRect();
      const scaleX = W() / rect.width;
      const scaleY = H() / rect.height;
      mouseWorld.x = (e.clientX - rect.left) * scaleX / CAMERA_ZOOM + camera.x;
      mouseWorld.y = (e.clientY - rect.top) * scaleY / CAMERA_ZOOM + camera.y;
    });

    canvas.addEventListener('mousedown', e => {
      e.preventDefault();
      if (e.button === 0) {
        const item = hotbarItens[hotbarSelecionado].id;
        if (item === 'espada') {
          attackEnemy();
        } else if (item === 'arco') {
          shootArrow();
        } else if (item === 'maca') {
          usarMaca();
        } else if (item === 'picareta' || item === 'superpicareta') {
          usePickaxeAt(mouseWorld.x, mouseWorld.y);
        } else {
          buildAt(mouseWorld.x, mouseWorld.y);
        }
      }
    });
    canvas.addEventListener('contextmenu', e => e.preventDefault());
    
    // Bot√µes mobile
    if (isMobile) {
        btnAction.addEventListener('touchstart', e => { e.preventDefault(); usarHotbarAtMouse(); }, {passive:false});
        btnCreate.addEventListener('touchstart', e => { e.preventDefault(); craftSelectedItem(); }, {passive:false});
    }

    // Joystick
    if (isMobile) {
        const joystickMaxRadius = joystickBase.clientWidth / 2;
        joystickArea.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (joystickTouchId !== null) return;
            const t = e.changedTouches[0];
            joystickTouchId = t.identifier;
        }, { passive: false });
    
        joystickArea.addEventListener('touchmove', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (touch.identifier === joystickTouchId) {
                    const rect = joystickArea.getBoundingClientRect();
                    let x = touch.clientX - rect.left - joystickMaxRadius;
                    let y = touch.clientY - rect.top - joystickMaxRadius;
                    const distance = Math.hypot(x, y);
                    if (distance > joystickMaxRadius) {
                        const angle = Math.atan2(y, x);
                        x = Math.cos(angle) * joystickMaxRadius;
                        y = Math.sin(angle) * joystickMaxRadius;
                    }
                    joystickStick.style.transform = `translate(${x}px, ${y}px)`;
                    
                    const deadzone = 20;
                    keyboard['w'] = y < -deadzone;
                    keyboard['s'] = y > deadzone;
                    keyboard['a'] = x < -deadzone;
                    keyboard['d'] = x > deadzone;
                    break;
                }
            }
        }, { passive: false });
    
        joystickArea.addEventListener('touchend', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === joystickTouchId) {
                    joystickTouchId = null;
                    joystickStick.style.transform = `translate(-50%, -50%)`;
                    keyboard['w'] = keyboard['s'] = keyboard['a'] = keyboard['d'] = false;
                    break;
                }
            }
        });
    }


    // Menus
    btnStart.onclick = () => {
        playSound('click');
        startMenu.style.display = 'none';
        gameContainer.style.display = 'block';
        initCanvas(); // Adicionei esta linha
        resetGame();
    };
    optionsBtn.onclick = () => {
        playSound('click');
        setPause(true);
        optionsMenu.style.display = 'flex';
        hudPanel.style.display = 'none';
    };
    btnResume.onclick = () => {
        playSound('click');
        optionsMenu.style.display = 'none';
        hudPanel.style.display = 'block';
        setPause(false);
    };
    btnGameOptions.onclick = () => {
        playSound('click');
        optionsMenu.style.display = 'none';
        gameOptionsMenu.style.display = 'flex';
    };
    btnBackOptions.onclick = () => {
        playSound('click');
        gameOptionsMenu.style.display = 'none';
        optionsMenu.style.display = 'flex';
    };

    // Op√ß√µes de Jogo
    function applyGameOptions() {
        hudPanel.style.transform = `scale(${hudSizeSlider.value}) translateX(-50%)`;
        hudPanel.style.transformOrigin = 'top center';
        btnAction.style.width = btnAction.style.height = `${btnSizeSlider.value * 60}px`;
        btnCreate.style.width = btnCreate.style.height = `${btnSizeSlider.value * 60}px`;
        joystickArea.style.width = joystickArea.style.height = `${joystickSizeSlider.value * 100}px`;
        joystickBase.style.width = joystickBase.style.height = '100%';
        joystickStick.style.width = joystickStick.style.height = `${joystickSizeSlider.value * 50}px`;
        joystickArea.style.left = `${joystickXSlider.value}%`;
        joystickArea.style.bottom = `${100 - joystickYSlider.value}%`;
        btnAction.parentNode.style.right = `${100 - btnXSlider.value}%`;
        btnAction.parentNode.style.bottom = `${100 - btnYSlider.value}%`;
    }
    
    hudSizeSlider.addEventListener('input', applyGameOptions);
    btnSizeSlider.addEventListener('input', applyGameOptions);
    joystickSizeSlider.addEventListener('input', applyGameOptions);
    joystickXSlider.addEventListener('input', applyGameOptions);
    joystickYSlider.addEventListener('input', applyGameOptions);
    btnXSlider.addEventListener('input', applyGameOptions);
    btnYSlider.addEventListener('input', applyGameOptions);
    
    // Inicia com as configura√ß√µes padr√£o
    applyGameOptions();

    function updateInventory() {
        const invDiv = document.getElementById('inv');
        let txt = `<span style="font-size: 14px;">üå≤: ${inventory.madeira} | ü™®: ${inventory.pedra} | üçé: ${inventory.maca} | üèπ: ${inventory.flechas} | üíé: ${inventory.gema} | üß™: ${inventory.pocao}</span>`;
        invDiv.innerHTML = txt;
        renderHotbar();
    }
    
    function updateCrafting() {
      const craftDiv = document.getElementById('craft');
      let txt = `<b>Constru√ß√£o:</b> `;
      const item = hotbarItens[hotbarSelecionado].id;
      if (item === buildMode) {
          txt += `${hotbarItens.find(i=>i.id===item).emoji} ${hotbarItens.find(i=>i.id===item).nome}`;
      } else {
          txt += '<span style="color:#aaa">Nenhum</span>';
      }
      craftDiv.innerHTML = txt;
    }

    function updateVida() {
      let hearts = '';
      for (let i = 0; i < Math.floor(player.vida); i++) hearts += '‚ù§Ô∏è';
      if (player.vida % 1 >= 0.5) hearts += 'üíî';
      vidaSpan.innerHTML = hearts;
      armaduraSpan.innerHTML = inventory.armadura ? 'ü¶∫' : '';
    }

    function craftSelectedItem() {
      playSound('click');
      const item = hotbarItens[hotbarSelecionado].id;
      if (item === 'espada' && !inventory.espada && inventory.madeira >= 3 && inventory.pedra >= 2) {
        inventory.madeira -= 3; inventory.pedra -= 2; inventory.espada = true; updateInventory();
      }
      if (item === 'picareta' && !inventory.picareta && inventory.madeira >= 2 && inventory.pedra >= 3) {
        inventory.madeira -= 2; inventory.pedra -= 3; inventory.picareta = true; updateInventory();
      }
      if (item === 'arco' && !inventory.arco && inventory.madeira >= 4) {
        inventory.madeira -= 4; inventory.arco = true; updateInventory();
      }
      if (item === 'tocha' && inventory.madeira >= 1 && inventory.pedra >= 1) {
        inventory.madeira -= 1; inventory.pedra -= 1; inventory.tocha += 1; updateInventory();
      }
      if (item === 'fogueira' && inventory.madeira >= 5) {
        inventory.madeira -= 5; inventory.fogueira += 1; updateInventory();
      }
      if (item === 'parede_madeira' && inventory.madeira >= 2) {
        inventory.madeira -= 2; inventory.parede_madeira += 1; updateInventory();
      }
      if (item === 'parede_pedra' && inventory.pedra >= 2) {
        inventory.pedra -= 2; inventory.parede_pedra += 1; updateInventory();
      }
      if (item === 'armadilha' && inventory.madeira >= 1 && inventory.pedra >= 1) {
        inventory.madeira -= 1; inventory.pedra -= 1; inventory.armadilha += 1; updateInventory();
      }
      if (item === 'mina' && inventory.mina > 0) {
        inventory.mina--; updateInventory();
      }
      if (item === 'maca' && inventory.madeira >= 2 && inventory.pedra >= 1) {
        inventory.madeira -= 2; inventory.pedra -= 1; inventory.maca += 1; updateInventory();
      }
      if (item === 'armadura' && !inventory.armadura && inventory.pedra >= 4 && inventory.madeira >= 2) {
        inventory.pedra -= 4; inventory.madeira -= 2;
        inventory.armadura = true; player.armadura = true; updateInventory(); updateVida();
      }
      if (item === 'superpicareta' && !inventory.superpicareta && inventory.gema >= 5) {
        inventory.gema -= 5; inventory.superpicareta = true; updateInventory();
      }
      if (item === 'tinteiro_magico' && inventory.gema >= 10) {
        inventory.gema -= 10; inventory.tinteiro_magico++; updateInventory();
      }
      if (item === 'pocao' && inventory.gema >= 3 && inventory.pedra >= 5) {
          inventory.gema -= 3; inventory.pedra -= 5; inventory.pocao++; updateInventory();
      }
    }

    function usarHotbarAtMouse() {
      const item = hotbarItens[hotbarSelecionado].id;
      if (item === 'espada') {
        attackEnemy();
      } else if (item === 'arco') {
        shootArrow();
      } else if (item === 'maca') {
        usarMaca();
      } else if (item === 'tinteiro_magico') {
        usarTinteiroMagico();
      } else if (item === 'pocao') {
        usarPocao();
      } else if (item === 'tocha' || item === 'parede_madeira' || item === 'parede_pedra' || item === 'armadilha' || item === 'mina' || item === 'fogueira') {
        buildMode = item;
        updateCrafting();
      } else if (item === 'picareta' || item === 'superpicareta') {
        usePickaxeAt(mouseWorld.x, mouseWorld.y);
      }
    }
    
    function usarMaca() {
      if (inventory.maca > 0 && player.vida < 5) {
        playSound('collect');
        inventory.maca--; player.vida = Math.min(5, player.vida + 2); updateInventory(); updateVida();
      }
    }

    function usarTinteiroMagico() {
        if (inventory.tinteiro_magico > 0) {
            playSound('collect');
            const newColor = prompt("Digite um c√≥digo de cor (ex: #ff0000, blue):", player.color);
            if (newColor) {
                player.color = newColor;
                inventory.tinteiro_magico--;
                updateInventory();
            }
        }
    }

    function usarPocao() {
      if (inventory.pocao > 0) {
        playSound('potion');
        player.speedModifier = 2;
        player.defenseModifier = 0.5;
        player.attackModifier = 2;
        player.effectTimer = 30; // 30 segundos
        inventory.pocao--;
        updateInventory();
      }
    }

    function attackEnemy() {
      if (!inventory.espada) return;
      playSound('attack');
      const attackPower = inventory.espada ? 1 : 0;
      for (let e of enemies) {
        if (!e.alive) continue;
        const dx = player.x + player.size/2 - (e.x + e.size/2);
        const dy = player.y + player.size/2 - (e.y + e.size/2);
        const dist = Math.hypot(dx, dy);
        if (dist < 54) {
          e.vida -= attackPower * player.attackModifier;
          if (e.vida <= 0) e.alive = false;
          return;
        }
      }
    }

    function shootArrow() {
      if (!inventory.arco || inventory.flechas <= 0) return;
      playSound('bow');
      inventory.flechas--;
      const dx = mouseWorld.x - player.x;
      const dy = mouseWorld.y - player.y;
      const angle = Math.atan2(dy, dx);
      const speed = 15;
      arrows.push({ x: player.x, y: player.y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed });
      updateInventory();
    }

    function usePickaxeAt(x, y) {
      if (!inventory.picareta && !inventory.superpicareta) return;
      playSound('attack');
      const radius = inventory.superpicareta ? 120 : 48;
      for (let i = materials.length-1; i >= 0; i--) {
        const m = materials[i];
        const dx = (m.x + m.size/2) - x;
        const dy = (m.y + m.size/2) - y;
        if (Math.hypot(dx,dy) <= radius) {
          if (m.type === 'madeira') inventory.madeira++;
          else if (m.type === 'pedra') inventory.pedra++;
          else if (m.type === 'madeira_floresta') inventory.madeira_floresta++;
          else if (m.type === 'gema') inventory.gema++;
          m.x = -100;
        }
      }
      for (let i = buildings.length-1; i >= 0; i--) {
        const b = buildings[i];
        const bx = b.x + b.size/2, by = b.y + b.size/2;
        if (Math.hypot(bx-x, by-y) <= radius) {
          if (b.type === 'parede_madeira') inventory.madeira += 1;
          if (b.type === 'parede_pedra') inventory.pedra += 2;
          buildings.splice(i,1);
        }
      }
      updateInventory();
      renderHotbar();
    }
    
    function buildAt(x, y) {
      if (!buildMode) return;
      let item = hotbarItens[hotbarSelecionado].id;
      if (item === 'tocha' && inventory.tocha > 0) {
        playSound('click');
        torches.push({ x: x-12, y: y-12, size: 24 });
        inventory.tocha--; updateInventory(); buildMode = null;
      } else if (item === 'parede_madeira' && inventory.parede_madeira > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'parede_madeira' });
        inventory.parede_madeira--; updateInventory(); buildMode = null;
      } else if (item === 'parede_pedra' && inventory.parede_pedra > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'parede_pedra' });
        inventory.parede_pedra--; updateInventory(); buildMode = null;
      } else if (item === 'armadilha' && inventory.armadilha > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'armadilha' });
        inventory.armadilha--; updateInventory(); buildMode = null;
      } else if (item === 'mina' && inventory.mina > 0) {
        playSound('click');
        bombs.push({ x: x-12, y: y-12, size: 24, timer: 900 });
        inventory.mina--; updateInventory(); buildMode = null;
      } else if (item === 'fogueira' && inventory.fogueira > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'fogueira' });
        inventory.fogueira--; updateInventory(); buildMode = null;
      } else {
        buildMode = null;
      }
      updateCrafting();
    }

    function spawnEnemy() {
      const edge = Math.floor(Math.random() * 4);
      let x, y;
      if (edge === 0) { x = 0; y = Math.random() * MAPA_ALTURA; }
      else if (edge === 1) { x = MAPA_LARGURA; y = Math.random() * MAPA_ALTURA; }
      else if (edge === 2) { x = Math.random() * MAPA_LARGURA; y = 0; }
      else { x = Math.random() * MAPA_LARGURA; y = MAPA_ALTURA; }

      let tipo = 'normal', cor = 'red', vida = 1, speed = 1.2 + Math.random(), dano = 1;
      if (dias >= 10 && Math.random() < 0.2) {
        tipo = 'rapido'; cor = '#ff9800'; speed = 2.5 + Math.random();
      }
      if (dias >= 25 && Math.random() < 0.15) {
        tipo = 'tanque'; cor = '#607d8b'; vida = 3; speed = 0.7 + Math.random()*0.5; dano = 2;
      }
      if (dias >= 100 && Math.random() < 0.1) {
        tipo = 'fantasma'; cor = '#b39ddb'; vida = 2; speed = 1.7 + Math.random(); dano = 2;
      }
      if (dias >= 200 && Math.random() < 0.07) {
        tipo = 'explosivo'; cor = '#fff176'; vida = 1; speed = 1.3 + Math.random(); dano = 3;
      }

      enemies.push({ x, y, size: 36, speed, dano, vida, alive: true, tipo, cor });
    }

    function spawnMaterials() {
        if (materials.length > 50) return;
        let x = Math.random() * MAPA_LARGURA;
        let y = Math.random() * MAPA_ALTURA;
        let type = Math.random() > 0.5 ? 'madeira' : 'pedra';
        if (dias > 50 && Math.random() < 0.2) type = 'gema';
        materials.push({ x, y, size: 20, type, collected: false });
    }

    function spawnApples() {
        if (apples.length > 10) return;
        let x = Math.random() * MAPA_LARGURA;
        let y = Math.random() * MAPA_ALTURA;
        apples.push({ x, y, size: 16 });
    }

    function drawBackground(now) {
      if (backgroundSelect.value === 'dynamic') {
        const timeOfDay = now % (dayLength * 1000) / (dayLength * 1000); // 0 a 1
        let r, g, b;
        if (timeOfDay < 0.5) { // Dia
            const dayProgress = timeOfDay / 0.5;
            r = 43 + (100 - 43) * dayProgress;
            g = 88 + (150 - 88) * dayProgress;
            b = 118 + (255 - 118) * dayProgress;
            ctx.fillStyle = `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
            ctx.fillRect(0, 0, W(), H());
            isDay = true;
        } else { // Noite
            const nightProgress = (timeOfDay - 0.5) / 0.5;
            r = 143 - (143 - 20) * nightProgress;
            g = 150 - (150 - 20) * nightProgress;
            b = 255 - (255 - 40) * nightProgress;
            ctx.fillStyle = `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
            ctx.fillRect(0, 0, W(), H());
            isDay = false;
        }
      } else {
        ctx.fillStyle = '#1c223c';
        ctx.fillRect(0, 0, W(), H());
        isDay = false;
      }
    }

    function drawWorld(now) {
      // Background
      drawBackground(now);

      // Part√≠culas
      ctx.globalAlpha = 1;
      particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        p.x += p.dx;
        p.y += p.dy;
        if (p.x > W()) p.x = 0; if (p.x < 0) p.x = W();
        if (p.y > H()) p.y = 0; if (p.y < 0) p.y = H();
      });

      // Desenhar mapa
      ctx.fillStyle = '#4CAF50';
      ctx.fillRect(0, 0, MAPA_LARGURA, MAPA_ALTURA);
      ctx.fillStyle = '#5c3a21';
      ctx.fillRect(0, 0, 100, MAPA_ALTURA);
      ctx.fillRect(MAPA_LARGURA-100, 0, 100, MAPA_ALTURA);
      ctx.fillRect(0, 0, MAPA_LARGURA, 100);
      ctx.fillRect(0, MAPA_ALTURA-100, MAPA_LARGURA, 100);
      
      if (florestaDesbloqueada) {
          ctx.fillStyle = '#388e3c';
          ctx.fillRect(MAPA_LARGURA/2, 0, MAPA_LARGURA/2, MAPA_ALTURA);
      }
      
      if (montanhaLiberada) {
          ctx.fillStyle = '#757575';
          ctx.beginPath();
          ctx.moveTo(MAPA_LARGURA/2, MAPA_ALTURA/2);
          ctx.lineTo(MAPA_LARGURA/2, MAPA_ALTURA);
          ctx.lineTo(MAPA_LARGURA, MAPA_ALTURA);
          ctx.lineTo(MAPA_LARGURA, MAPA_ALTURA/2);
          ctx.closePath();
          ctx.fill();
      }

      // Itens
      materials.forEach(m => {
        ctx.fillStyle = m.type === 'madeira' ? 'brown' : m.type === 'pedra' ? 'grey' : m.type === 'gema' ? 'purple' : '#8B4513';
        ctx.fillRect(m.x, m.y, m.size, m.size);
      });
      
      apples.forEach(a => {
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(a.x + a.size/2, a.y + a.size/2, a.size/2, 0, Math.PI*2);
        ctx.fill();
      });

      // Inimigos
      enemies.forEach(e => {
        ctx.fillStyle = e.cor;
        ctx.beginPath();
        ctx.arc(e.x + e.size/2, e.y + e.size/2, e.size/2, 0, Math.PI*2);
        ctx.fill();
        if (e.tipo === 'fantasma') {
            ctx.fillStyle = '#fff';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üëª', e.x + e.size/2, e.y + e.size/2);
        }
      });
      
      // Bombas
      bombs.forEach(b => {
        ctx.fillStyle = b.timer > 30 ? 'black' : 'red';
        ctx.fillRect(b.x, b.y, b.size, b.size);
      });
      
      // Flechas
      arrows.forEach(a => {
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(a.x + a.vx*1.5, a.y + a.vy*1.5);
        ctx.stroke();
      });

      // Constru√ß√µes
      buildings.forEach(b => {
        if (b.type === 'parede_madeira') {
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(b.x, b.y, b.size, b.size);
        } else if (b.type === 'parede_pedra') {
            ctx.fillStyle = '#444';
            ctx.fillRect(b.x, b.y, b.size, b.size);
        } else if (b.type === 'fogueira') {
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.arc(b.x + b.size/2, b.y + b.size/2, b.size/2, 0, Math.PI*2);
            ctx.fill();
        } else if (b.type === 'armadilha') {
            ctx.fillStyle = '#222';
            ctx.fillRect(b.x, b.y, b.size, b.size);
        }
      });
      
      torches.forEach(t => {
        ctx.fillStyle = '#ffcc00';
        ctx.beginPath();
        ctx.arc(t.x + t.size/2, t.y + t.size/2, t.size/2, 0, Math.PI*2);
        ctx.fill();
      });
      
      // Desenhar outros jogadores
      for (const id in otherPlayers) {
        if (id === socket.id) continue;
        const otherPlayer = otherPlayers[id];
        ctx.save();
        ctx.fillStyle = otherPlayer.color;
        ctx.translate(otherPlayer.x, otherPlayer.y);
        ctx.rotate(otherPlayer.angle);
        ctx.fillRect(-otherPlayer.size/2, -otherPlayer.size/2, otherPlayer.size, otherPlayer.size);
        ctx.restore();
        
        // Nome do jogador
        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(otherPlayer.name, otherPlayer.x, otherPlayer.y - otherPlayer.size/2 - 5);
      }

      // Desenhar Jogador
      ctx.save();
      ctx.translate(player.x, player.y);
      ctx.rotate(player.angle);
      
      if (player.invencivel % 10 < 5) {
        ctx.fillStyle = player.color;
        ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size);
        if (inventory.armadura) {
            ctx.fillStyle = 'blue';
            ctx.fillRect(-player.size/2, -player.size/2, player.size, player.size);
        }
      }
      
      ctx.restore();

      // Desenhar HUD
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      if (buildMode) {
          ctx.fillStyle = 'rgba(255,255,255,0.4)';
          ctx.fillRect(mouseWorld.x, mouseWorld.y, 40, 40);
      }
      ctx.restore();
    }
    
    function gameLoop(now) {
      if (!running) {
        timerSpan.textContent = elapsed.toFixed(1);
        ctx.save();
        ctx.globalAlpha = 0.85;
        ctx.fillStyle = '#222b';
        ctx.fillRect(W()/2-180, H()/2-80, 360, 160);
        ctx.globalAlpha = 1;
        ctx.fillStyle = 'white';
        ctx.font = '38px Arial';
        ctx.textAlign = "center";
        ctx.fillText('Game Over!', W()/2, H()/2-10);
        ctx.font = '24px Arial';
        ctx.fillText('Tempo: ' + elapsed.toFixed(1) + ' s', W()/2, H()/2+30);
        ctx.restore();
        if (currentMusic) { currentMusic.pause(); }
        return;
      }
      
      if (paused) {
        requestAnimationFrame(gameLoop);
        return;
      }
      
      const lastNow = gameLoop.lastNow || now;
      const delta = (now - lastNow) / 1000;
      gameLoop.lastNow = now;

      elapsed += delta;
      
      // Atualizar tempo e dias
      timerSpan.textContent = elapsed.toFixed(1);
      const newDias = Math.floor(elapsed / dayLength) + 1;
      if (newDias > lastDay) {
        lastDay = newDias;
        dias = newDias;
        diasSpan.textContent = `Dia ${dias}`;
        spawnEnemy();
        if (dias === 5) spawnApples();
      }
      
      // L√≥gica de movimento e colis√£o
      const speedX = (keyboard['d'] - keyboard['a']) * player.speed * player.speedModifier;
      const speedY = (keyboard['s'] - keyboard['w']) * player.speed * player.speedModifier;
      
      player.x += speedX;
      player.y += speedY;
      
      // Clamp player position
      player.x = Math.max(0, Math.min(MAPA_LARGURA - player.size, player.x));
      player.y = Math.max(0, Math.min(MAPA_ALTURA - player.size, player.y));
      
      if (speedX !== 0 || speedY !== 0) {
        player.angle = Math.atan2(speedY, speedX);
        socket.emit('playerState', { x: player.x, y: player.y, angle: player.angle });
      }

      // Atualizar c√¢mera
      camera.x = player.x - W() / (2 * CAMERA_ZOOM);
      camera.y = player.y - H() / (2 * CAMERA_ZOOM);
      camera.x = Math.max(0, Math.min(MAPA_LARGURA - W()/CAMERA_ZOOM, camera.x));
      camera.y = Math.max(0, Math.min(MAPA_ALTURA - H()/CAMERA_ZOOM, camera.y));
      
      // L√≥gica do jogo
      if (player.effectTimer > 0) {
        player.effectTimer -= delta;
        if (player.effectTimer <= 0) {
            player.speedModifier = 1;
            player.defenseModifier = 1;
            player.attackModifier = 1;
        }
      }

      // Colis√£o com inimigos
      enemies.forEach(e => {
        if (!e.alive) return;
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.hypot(dx, dy);
        if (dist < player.size/2 + e.size/2 && player.invencivel <= 0) {
          player.vida -= e.dano * player.defenseModifier;
          player.invencivel = 120;
          playSound('damage');
          updateVida();
        }
        if (player.vida <= 0) running = false;
        
        // Movimento dos inimigos
        const angle = Math.atan2(player.y - e.y, player.x - e.x);
        e.x += Math.cos(angle) * e.speed;
        e.y += Math.sin(angle) * e.speed;
      });

      // Colis√£o de flechas com inimigos
      arrows.forEach(a => {
        a.x += a.vx;
        a.y += a.vy;
        for (let e of enemies) {
          if (!e.alive) continue;
          const dx = a.x - e.x;
          const dy = a.y - e.y;
          if (Math.hypot(dx, dy) < e.size/2) {
            e.vida -= 1;
            if (e.vida <= 0) e.alive = false;
            a.alive = false;
          }
        }
      });
      arrows = arrows.filter(a => a.alive !== false);

      // Colis√£o com materiais
      materials.forEach(m => {
        const dx = player.x - m.x;
        const dy = player.y - m.y;
        if (Math.hypot(dx,dy) < player.size/2 + m.size/2) {
          if (m.type === 'madeira') inventory.madeira++;
          else if (m.type === 'pedra') inventory.pedra++;
          else if (m.type === 'gema') inventory.gema++;
          m.x = -100;
          playSound('collect');
          updateInventory();
        }
      });
      materials = materials.filter(m => m.x > -100);
      
      // Colis√£o com ma√ß√£s
      apples.forEach(a => {
        const dx = player.x - a.x;
        const dy = player.y - a.y;
        if (Math.hypot(dx, dy) < player.size/2 + a.size/2) {
          inventory.maca++;
          a.x = -100;
          playSound('collect');
          updateInventory();
        }
      });
      apples = apples.filter(a => a.x > -100);

      // L√≥gica de armadilhas e minas
      buildings.forEach(b => {
        if (b.type === 'armadilha') {
          enemies.forEach(e => {
            if (!e.alive) return;
            const dx = b.x - e.x;
            const dy = b.y - e.y;
            if (Math.hypot(dx,dy) < b.size/2 + e.size/2) {
              e.speed = 0.5;
            } else {
              if (e.tipo === 'rapido') e.speed = 2.5; else e.speed = 1.2;
            }
          });
        }
      });
      
      bombs.forEach(b => {
        b.timer -= 1;
        if (b.timer <= 0) {
          playSound('explosion');
          enemies.forEach(e => {
            const dx = b.x - e.x;
            const dy = b.y - e.y;
            const dist = Math.hypot(dx,dy);
            if (dist < 100) e.vida -= 5;
            if (e.vida <= 0) e.alive = false;
          });
          b.timer = -100;
        }
      });
      bombs = bombs.filter(b => b.timer > -100);

      // Desenhar
      ctx.clearRect(0, 0, W(), H());
      ctx.save();
      ctx.translate(-camera.x, -camera.y);
      drawWorld(now);
      ctx.restore();
    
      if (player.invencivel > 0) player.invencivel--;
      if (!isDay && Math.floor(elapsed * 10) % 15 === 0 && enemies.length < Math.floor(elapsed / 2) + 2) spawnEnemy();
      if (Math.floor(elapsed) % 14 === 0 && Math.floor(elapsed) !== 0 && Math.floor(elapsed * 10) % 10 === 0) spawnMaterials();
    
      requestAnimationFrame(gameLoop);
    }

    // Multiplayer
    socket.on('connect', () => {
        console.log('Conectado ao servidor.');
    });

    socket.on('currentPlayers', (playersData) => {
        for (let id in playersData) {
            if (id === socket.id) {
                player.id = id;
            } else {
                otherPlayers[id] = playersData[id];
            }
        }
    });

    socket.on('newPlayer', (playerData) => {
        otherPlayers[playerData.id] = playerData;
    });

    socket.on('playerDisconnected', (playerId) => {
        delete otherPlayers[playerId];
    });

    socket.on('allPlayersState', (playersData) => {
        for (let id in playersData) {
            if (id === socket.id) {
                if (player.id) {
                    player = { ...player, ...playersData[id] };
                }
            } else {
                otherPlayers[id] = playersData[id];
            }
        }
    });
    
    // Inicia o canvas e o loop do jogo quando a p√°gina carrega
    window.onload = initCanvas;
  </script>
</body>
</html>