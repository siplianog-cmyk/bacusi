<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jogo de Sobreviv√™ncia JS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    /* Estilos globais */
    html, body {
        margin: 0; padding: 0;
        width: 100vw; height: 100vh;
        overflow: hidden;
        background: #222;
        font-family: 'Segoe UI', Arial, sans-serif;
        background: linear-gradient(120deg, #2b5876 0%, #4e4376 100%);
        touch-action: none;
        color: #fff;
    }
    
    /* Telas de Menu e In√≠cio */
    .overlay-menu {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(18, 18, 30, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200;
        text-align: center;
        backdrop-filter: blur(8px);
    }
    .overlay-menu h1 {
        font-size: 3em;
        text-shadow: 2px 2px 12px #000;
        color: #ffe066;
    }
    .overlay-menu button, .overlay-menu input[type="range"], .overlay-menu select {
        padding: 12px 36px;
        font-size: 1.5em;
        border-radius: 12px;
        border: none;
        background: #ffe066;
        color: #222;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        transition: background 0.2s;
        margin-top: 24px;
        width: 80%;
        max-width: 300px;
    }
    .overlay-menu button:hover { background: #fff176; }
    
    /* Rolagem para o menu de op√ß√µes */
    .scrollable-content {
        overflow-y: auto;
        max-height: 80vh;
        padding: 20px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    /* HUD */
    #hud-panel {
      position: absolute;
      top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(40,40,60,0.85);
      border-radius: 12px;
      box-shadow: 0 4px 16px #000a;
      padding: 6px 16px 4px 16px;
      color: #fff;
      font-size: 0.8em;
      text-align: left;
      text-shadow: 1px 1px 4px #000;
      z-index: 10;
      min-width: 280px;
      max-width: 90vw;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    /* Hotbar estilo Minecraft */
    #hotbar {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 10;
        user-select: none;
    }
    .slot {
        width: 50px; height: 50px;
        background: rgba(30,30,40,0.8);
        border: 3px solid #444;
        border-radius: 10px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        transition: transform 0.1s, border-color 0.1s;
    }
    .slot.active {
        border-color: #ffe066;
        transform: scale(1.1);
        box-shadow: 0 0 12px rgba(255, 224, 102, 0.7);
    }
    .item-count {
        position: absolute;
        bottom: 2px; right: 4px;
        font-size: 0.7em;
        text-shadow: 1px 1px 2px #000;
    }
    
    /* Bot√µes flutuantes para mobile */
    #action-buttons {
        position: absolute;
        right: 10px;
        bottom: 100px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 100;
    }
    #action-buttons button {
        width: 60px; height: 60px;
        border-radius: 50%;
        border: none;
        background: rgba(255,255,255,.3);
        color: #000;
        font-size: 1.6em;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    #options-btn {
        position: absolute;
        top: 15px; right: 15px;
        width: 40px; height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6em;
        cursor: pointer;
        z-index: 20;
    }
    
    /* Visuais */
    .heart { color: #ff5252; font-size: 1em; text-shadow: 0 0 4px #fff, 0 0 1px #f00; }
    .armor { color: #b0c4de; font-size: 1em; text-shadow: 0 0 4px #fff, 0 0 1px #09f; }
    #pauseOverlay {
      position: absolute;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(20,20,40,0.8);
      z-index: 99;
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 3em;
      font-weight: bold;
      text-shadow: 2px 2px 12px #000;
      pointer-events: none;
    }
    canvas {
      display: block;
      position: absolute;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: transparent;
      border: none;
      margin: 0;
      z-index: 1;
    }

    /* Joystick */
    #joystick-area {
        position: absolute;
        bottom: 40px; left: 40px;
        width: 100px; height: 100px;
        display: block;
        touch-action: none;
        z-index: 100;
    }
    #joystick-base {
        width: 100%; height: 100%;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        position: relative;
    }
    #joystick-stick {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 50px; height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
    }
    .option-label {
        font-size: 1em;
        margin-top: 16px;
    }
  </style>
</head>
<body>
  <div id="start-menu" class="overlay-menu">
      <h1>Jogo de Sobreviv√™ncia</h1>
      <p>Escolha sua cor:</p>
      <input type="color" id="color-picker" value="#00e6ff">
      <button id="btn-start">Come√ßar</button>
  </div>
  
  <div id="options-menu" class="overlay-menu" style="display: none;">
      <div class="scrollable-content">
          <h1>Op√ß√µes</h1>
          <p class="option-label">Volume do Jogo:</p>
          <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5">
          <p class="option-label">Multiplayer:</p>
          <label class="switch" style="font-size:1.5em; margin-top:16px;">
            <input type="checkbox" id="multiplayer-toggle">
            <span class="slider"></span>
          </label>
          <p class="option-label">Fundo do Jogo:</p>
          <select id="background-select" style="font-size:1.2em; padding:8px; margin-top:8px;">
            <option value="dynamic">Din√¢mico</option>
            <option value="beta">Vers√£o Beta</option>
          </select>
          <button id="btn-game-options">Op√ß√µes de Jogo</button>
          <button id="btn-resume">Continuar</button>
      </div>
  </div>
  
  <div id="game-options-menu" class="overlay-menu" style="display: none;">
      <div class="scrollable-content">
          <h1>Configura√ß√µes de Jogo</h1>
          <p class="option-label">Tamanho da HUD:</p>
          <input type="range" id="hud-size-slider" min="0.5" max="2" step="0.1" value="1">
          <p class="option-label">Tamanho dos Bot√µes:</p>
          <input type="range" id="btn-size-slider" min="0.5" max="2" step="0.1" value="1.2">
          <p class="option-label">Tamanho do Joystick:</p>
          <input type="range" id="joystick-size-slider" min="0.5" max="2" step="0.1" value="1.2">
          <p class="option-label">Posi√ß√£o do Joystick (Horizontal):</p>
          <input type="range" id="joystick-x-slider" min="10" max="90" step="1" value="20">
          <p class="option-label">Posi√ß√£o do Joystick (Vertical):</p>
          <input type="range" id="joystick-y-slider" min="10" max="90" step="1" value="80">
          <p class="option-label">Posi√ß√£o dos Bot√µes (Horizontal):</p>
          <input type="range" id="btn-x-slider" min="10" max="90" step="1" value="85">
          <p class="option-label">Posi√ß√£o dos Bot√µes (Vertical):</p>
          <input type="range" id="btn-y-slider" min="10" max="90" step="1" value="80">
          <button id="btn-back-options">Voltar</button>
      </div>
  </div>

  <div id="game-container">
    <div id="hud-panel">
      <div id="info">
        <span id="timer">0.0</span> s &nbsp;|&nbsp; 
        <span id="dias">Dia 1</span> &nbsp;|&nbsp;
        <span class="heart" id="vida"></span>
        <span class="armor" id="armadura"></span>
      </div>
      <div id="inv"></div>
      <div id="craft"></div>
    </div>
  
    <div id="hotbar"></div>
  
    <canvas id="game"></canvas>
    <div id="pauseOverlay">PAUSADO</div>
  
    <div id="joystick-area">
        <div id="joystick-base">
            <div id="joystick-stick"></div>
        </div>
    </div>
  
    <div id="action-buttons">
        <button id="btn-action">E</button>
        <button id="btn-create">Q</button>
    </div>
    <button id="options-btn">‚öôÔ∏è</button>
    <button id="restart" style="display:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:20;">Recome√ßar</button>
  </div>

  <script>
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    const startMenu = document.getElementById('start-menu');
    const optionsMenu = document.getElementById('options-menu');
    const gameOptionsMenu = document.getElementById('game-options-menu');
    const gameContainer = document.getElementById('game-container');
    const btnStart = document.getElementById('btn-start');
    const btnResume = document.getElementById('btn-resume');
    const btnGameOptions = document.getElementById('btn-game-options');
    const btnBackOptions = document.getElementById('btn-back-options');
    const optionsBtn = document.getElementById('options-btn');
    const btnAction = document.getElementById('btn-action');
    const btnCreate = document.getElementById('btn-create');
    const joystickArea = document.getElementById('joystick-area');
    const joystickBase = document.getElementById('joystick-base');
    const joystickStick = document.getElementById('joystick-stick');
    const volumeSlider = document.getElementById('volume-slider');
    const multiplayerToggle = document.getElementById('multiplayer-toggle');
    const hudSizeSlider = document.getElementById('hud-size-slider');
    const btnSizeSlider = document.getElementById('btn-size-slider');
    const joystickSizeSlider = document.getElementById('joystick-size-slider');
    const joystickXSlider = document.getElementById('joystick-x-slider');
    const joystickYSlider = document.getElementById('joystick-y-slider');
    const btnXSlider = document.getElementById('btn-x-slider');
    const btnYSlider = document.getElementById('btn-y-slider');
    const colorPicker = document.getElementById('color-picker');
    const backgroundSelect = document.getElementById('background-select');

    if (!isMobile) {
        joystickArea.style.display = 'none';
        document.getElementById('action-buttons').style.display = 'none';
    }
    
    const MAPA_LARGURA = 2400;
    const MAPA_ALTURA = 1200;
    let camera = { x: 0, y: 0 };
    let florestaDesbloqueada = false;
    
    const canvas = document.getElementById('game');
    let ctx = null;
    let CAMERA_ZOOM = 1;

    // SONS e M√öSICAS
    const soundUrls = {
      click: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/click.mp3',
      collect: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/collect.mp3',
      attack: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/attack.mp3',
      damage: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/damage.mp3',
      explosion: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/explosion.mp3',
      step: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/step.mp3',
      potion: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/potion.mp3',
      bow: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/bow.mp3',
      mine: 'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/sounds/mine.mp3',
    };

    const musicUrls = [
      'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/music/1.mp3',
      'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/music/2.mp3',
      'https://cdn.jsdelivr.net/gh/dev-lucca/game-assets@main/music/3.mp3',
    ];

    const sounds = {};
    let currentMusic = null;
    let musicIndex = 0;
    
    for (const key in soundUrls) {
        sounds[key] = new Audio(soundUrls[key]);
    }
    
    function playSound(soundName) {
        if (sounds[soundName]) {
            sounds[soundName].volume = volumeSlider.value;
            sounds[soundName].play().catch(e => console.log("Erro ao tocar o som:", e));
        }
    }
    
    function playNextMusic() {
        if (currentMusic) {
            currentMusic.pause();
            currentMusic.currentTime = 0;
        }
        
        musicIndex = (musicIndex + 1) % musicUrls.length;
        currentMusic = new Audio(musicUrls[musicIndex]);
        currentMusic.volume = volumeSlider.value;
        currentMusic.loop = false;
        currentMusic.onended = playNextMusic;
        currentMusic.play().catch(e => console.log("Erro ao tocar m√∫sica:", e));
    }
    
    volumeSlider.addEventListener('input', (e) => {
        for (let sound in sounds) {
            sounds[sound].volume = e.target.value;
        }
        if (currentMusic) {
            currentMusic.volume = e.target.value;
        }
    });

    function initCanvas() {
        if (!canvas) {
            console.error('Canvas element not found.');
            return;
        }
        ctx = canvas.getContext('2d');
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
        if (!canvas) return;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Novo c√°lculo de zoom para mobile
        if (isMobile) {
          const gameAspect = MAPA_LARGURA / MAPA_ALTURA;
          const screenAspect = window.innerWidth / window.innerHeight;
          // Zoom para preencher a tela sem distorcer, focando em manter a √°rea de jogo vis√≠vel
          CAMERA_ZOOM = Math.min(window.innerWidth / MAPA_LARGURA, window.innerHeight / MAPA_ALTURA);
          // Adiciona um pouco de zoom para que o jogador n√£o seja min√∫sculo
          CAMERA_ZOOM = Math.max(0.5, CAMERA_ZOOM);
        } else {
            CAMERA_ZOOM = 1;
        }
    }

    const W = () => canvas.width;
    const H = () => canvas.height;

    const keyboard = {};

    document.addEventListener('keydown', (e) => {
      keyboard[e.key.toLowerCase()] = true;
    });

    document.addEventListener('keyup', (e) => {
      keyboard[e.key.toLowerCase()] = false;
    });

    const timerSpan = document.getElementById('timer');
    const vidaSpan = document.getElementById('vida');
    const armaduraSpan = document.getElementById('armadura');
    const diasSpan = document.getElementById('dias');
    const hudPanel = document.getElementById('hud-panel');
    const hotbarDiv = document.getElementById('hotbar');
    const pauseOverlay = document.getElementById('pauseOverlay');
    const restartBtn = document.getElementById('restart');
    
    const hotbarItens = [
      { id: 'espada', nome: 'Espada', emoji: '‚öîÔ∏è' },
      { id: 'arco', nome: 'Arco', emoji: 'üèπ' },
      { id: 'picareta', nome: 'Picareta', emoji: '‚õèÔ∏è' },
      { id: 'maca', nome: 'Ma√ß√£', emoji: 'üçé' },
      { id: 'tocha', nome: 'Tocha', emoji: 'üî•' },
      { id: 'parede_madeira', nome: 'Parede Madeira', emoji: 'üü´' },
      { id: 'parede_pedra', nome: 'Parede de Pedra', emoji: 'üß±' },
      { id: 'armadilha', nome: 'Armadilha', emoji: 'üï∏Ô∏è' },
      { id: 'mina', nome: 'Mina Explosiva', emoji: 'üí£' },
      { id: 'fogueira', nome: 'Fogueira', emoji: 'üèïÔ∏è' },
      { id: 'tinteiro_magico', nome: 'Tinteiro M√°gico', emoji: 'üñåÔ∏è' },
      { id: 'pocao', nome: 'Po√ß√£o For√ßa', emoji: 'üß™' },
    ];
    let hotbarSelecionado = 0;
    
    // Multiplayer
    let ws = null;
    let isMultiplayerEnabled = false;
    let otherPlayers = {};

    multiplayerToggle.addEventListener('change', () => {
        isMultiplayerEnabled = multiplayerToggle.checked;
    });
    
    function setupMultiplayer() {
        if (!isMultiplayerEnabled) {
            if (ws) { ws.close(); ws = null; otherPlayers = {}; }
            return;
        }

        if (ws) return;

        ws = new WebSocket('ws://localhost:3000');
        
        ws.onopen = () => {
            console.log('Conectado ao servidor WebSocket');
            player.id = Date.now().toString(); // ID √∫nico para o jogador
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'playerUpdate') {
                otherPlayers = data.players;
                delete otherPlayers[player.id];
            } else if (data.type === 'playerDisconnected') {
                delete otherPlayers[data.id];
            }
        };

        ws.onclose = () => {
            console.log('Desconectado do servidor WebSocket');
            ws = null;
            otherPlayers = {};
        };

        ws.onerror = (error) => {
            console.error('Erro no WebSocket:', error);
        };
    }
    
    function sendPlayerUpdate() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            const playerState = {
                id: player.id,
                x: player.x,
                y: player.y,
                color: player.color,
                vida: player.vida,
                armadura: player.armadura,
                attackModifier: player.attackModifier,
                defenseModifier: player.defenseModifier,
                speedModifier: player.speedModifier,
                effectTimer: player.effectTimer,
                invencivel: player.invencivel
            };
            ws.send(JSON.stringify({ type: 'playerUpdate', player: playerState }));
        }
    }


    function renderHotbar() {
      const hotbarElement = document.getElementById('hotbar');
      if (!hotbarElement) return;
      hotbarElement.innerHTML = '';
      hotbarItens.forEach((item, i) => {
        const slot = document.createElement('div');
        slot.className = `slot`;
        if (hotbarSelecionado === i) {
          slot.classList.add('active');
        }
        slot.innerHTML = `<span>${item.emoji}</span>`;
        if (inventory[item.id] !== undefined) {
          const count = document.createElement('span');
          count.className = 'item-count';
          if (typeof inventory[item.id] === 'boolean') {
            count.textContent = inventory[item.id] ? '‚úîÔ∏è' : '';
          } else {
            count.textContent = inventory[item.id] > 0 ? inventory[item.id] : '';
          }
          slot.appendChild(count);
        }
        slot.onclick = () => { playSound('click'); hotbarSelecionado = i; renderHotbar(); };
        hotbarElement.appendChild(slot);
      });
    }

    let particles = [];
    function resetParticles() {
      particles = [];
      for (let i = 0; i < 32; i++) {
        particles.push({
          x: Math.random() * W(),
          y: Math.random() * H(),
          r: 30 + Math.random() * 60,
          dx: (Math.random() - 0.5) * 0.2,
          dy: (Math.random() - 0.5) * 0.2,
          color: `rgba(${180+Math.random()*60},${200+Math.random()*40},255,${0.08+Math.random()*0.08})`
        });
      }
    }
    resetParticles();
    window.addEventListener('resize', resetParticles);

    let player, enemies, materials, buildings, torches, apples, gems, running, startTime, elapsed, inventory, isDay, dayLength, buildMode, dias, montanhaLiberada, dayTransitionActive, lastDay, paused, mouseWorld = { x: 0, y: 0 };
    let bombs = [];
    let joystickTimeout = null;
    let joystickTouchId = null;
    let arrows = [];

    function resetGame() {
      player = { 
        x: MAPA_LARGURA / 2, 
        y: MAPA_ALTURA / 2, 
        size: 40, 
        speed: 4, 
        baseSpeed: 4,
        blink: 0, 
        vida: 5, 
        armadura: false, 
        invencivel: 0, 
        id: null,
        color: colorPicker.value,
        attackModifier: 1,
        defenseModifier: 1,
        speedModifier: 1,
        effectTimer: 0
      };
      enemies = [];
      materials = [];
      buildings = [];
      torches = [];
      apples = [];
      gems = [];
      bombs = [];
      running = true;
      paused = false;
      startTime = performance.now();
      elapsed = 0;
      inventory = {
        madeira: 0,
        pedra: 0,
        flechas: 0,
        espada: false,
        picareta: false,
        arco: false,
        tocha: 0,
        fogueira: 0,
        parede_madeira: 0,
        parede_pedra: 0,
        armadilha: 0,
        mina: 0,
        maca: 0,
        armadura: false,
        gema: 0,
        pocao: 0,
        superpicareta: false,
        tinteiro_magico: 0
      };
      
      dayTransitionActive = false;
      isDay = true;
      dayLength = 14;
      buildMode = null;
      dias = 1;
      lastDay = 1;
      montanhaLiberada = false;
      florestaDesbloqueada = false;
      
      renderHotbar();
      updateInventory();
      updateCrafting();
      updateVida();
      resetParticles();
      spawnEnemy();
      spawnMaterials();

      restartBtn.style.display = 'none';

      requestAnimationFrame(gameLoop);
      if (currentMusic) { currentMusic.pause(); }
      playNextMusic();
      
      setupMultiplayer();
    }

    function setPause(val) {
      paused = val;
      pauseOverlay.style.display = paused ? 'flex' : 'none';
      if (!paused && !dayTransitionActive) requestAnimationFrame(gameLoop);
      if (currentMusic) {
        if (paused) currentMusic.pause();
        else currentMusic.play();
      }
    }
    
    // Controles e Eventos
    document.addEventListener('keydown', e => {
      const key = e.key.toLowerCase();
      if (paused && key !== 'p' && key !== 'escape') return;
      keyboard[key] = true;
      if (key === 'p' || key === 'escape') { setPause(!paused); }
      if (key >= '1' && key <= '9') { hotbarSelecionado = parseInt(key)-1; renderHotbar(); }
      if (key === '0') { hotbarSelecionado = 9; renderHotbar(); }
      if (key === ' ') attackEnemy();
      if (key === 'q' || key === 'z') { craftSelectedItem(); }
      if (key === 'e' || key === 'x') { usarHotbarAtMouse(); }
    });

    document.addEventListener('keyup', e => {
      keyboard[e.key.toLowerCase()] = false;
    });

    hotbarDiv.addEventListener('wheel', e => {
      e.preventDefault();
      playSound('click');
      if (e.deltaY > 0) hotbarSelecionado = (hotbarSelecionado + 1) % hotbarItens.length;
      else hotbarSelecionado = (hotbarSelecionado + hotbarItens.length - 1) % hotbarItens.length;
      renderHotbar();
    }, {passive:false});

    canvas.addEventListener('mousemove', e=>{
      const rect = canvas.getBoundingClientRect();
      const scaleX = W() / rect.width;
      const scaleY = H() / rect.height;
      mouseWorld.x = (e.clientX - rect.left) * scaleX / CAMERA_ZOOM + camera.x;
      mouseWorld.y = (e.clientY - rect.top) * scaleY / CAMERA_ZOOM + camera.y;
    });

    canvas.addEventListener('mousedown', e => {
      e.preventDefault();
      if (e.button === 0) {
        const item = hotbarItens[hotbarSelecionado].id;
        if (item === 'espada') {
          attackEnemy();
        } else if (item === 'arco') {
          shootArrow();
        } else if (item === 'maca') {
          usarMaca();
        } else if (item === 'picareta' || item === 'superpicareta') {
          usePickaxeAt(mouseWorld.x, mouseWorld.y);
        } else {
          buildAt(mouseWorld.x, mouseWorld.y);
        }
      }
    });
    canvas.addEventListener('contextmenu', e => e.preventDefault());
    
    // Bot√µes mobile
    if (isMobile) {
        btnAction.addEventListener('touchstart', e => { e.preventDefault(); usarHotbarAtMouse(); }, {passive:false});
        btnCreate.addEventListener('touchstart', e => { e.preventDefault(); craftSelectedItem(); }, {passive:false});
    }

    // Joystick
    if (isMobile) {
        const joystickMaxRadius = joystickBase.clientWidth / 2;
        joystickArea.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (joystickTouchId !== null) return;
            const t = e.changedTouches[0];
            joystickTouchId = t.identifier;
        }, { passive: false });
    
        joystickArea.addEventListener('touchmove', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (touch.identifier === joystickTouchId) {
                    const rect = joystickArea.getBoundingClientRect();
                    let x = touch.clientX - rect.left - joystickMaxRadius;
                    let y = touch.clientY - rect.top - joystickMaxRadius;
                    const distance = Math.hypot(x, y);
                    if (distance > joystickMaxRadius) {
                        const angle = Math.atan2(y, x);
                        x = Math.cos(angle) * joystickMaxRadius;
                        y = Math.sin(angle) * joystickMaxRadius;
                    }
                    joystickStick.style.transform = `translate(${x}px, ${y}px)`;
                    
                    const deadzone = 20;
                    keyboard['w'] = y < -deadzone;
                    keyboard['s'] = y > deadzone;
                    keyboard['a'] = x < -deadzone;
                    keyboard['d'] = x > deadzone;
                    break;
                }
            }
        }, { passive: false });
    
        joystickArea.addEventListener('touchend', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === joystickTouchId) {
                    joystickTouchId = null;
                    joystickStick.style.transform = `translate(-50%, -50%)`;
                    keyboard['w'] = keyboard['s'] = keyboard['a'] = keyboard['d'] = false;
                    break;
                }
            }
        });
    }


    // Menus
    btnStart.onclick = () => {
        playSound('click');
        startMenu.style.display = 'none';
        gameContainer.style.display = 'block';
        resetGame();
    };
    optionsBtn.onclick = () => {
        playSound('click');
        setPause(true);
        optionsMenu.style.display = 'flex';
        hudPanel.style.display = 'none';
    };
    btnResume.onclick = () => {
        playSound('click');
        isMultiplayerEnabled = multiplayerToggle.checked;
        setupMultiplayer();
        optionsMenu.style.display = 'none';
        hudPanel.style.display = 'block';
        setPause(false);
    };
    btnGameOptions.onclick = () => {
        playSound('click');
        optionsMenu.style.display = 'none';
        gameOptionsMenu.style.display = 'flex';
    };
    btnBackOptions.onclick = () => {
        playSound('click');
        gameOptionsMenu.style.display = 'none';
        optionsMenu.style.display = 'flex';
    };

    // Op√ß√µes de Jogo
    function applyGameOptions() {
        hudPanel.style.transform = `scale(${hudSizeSlider.value}) translateX(-50%)`;
        hudPanel.style.transformOrigin = 'top center';
        btnAction.style.width = btnAction.style.height = `${btnSizeSlider.value * 60}px`;
        btnCreate.style.width = btnCreate.style.height = `${btnSizeSlider.value * 60}px`;
        joystickArea.style.width = joystickArea.style.height = `${joystickSizeSlider.value * 100}px`;
        joystickBase.style.width = joystickBase.style.height = '100%';
        joystickStick.style.width = joystickStick.style.height = `${joystickSizeSlider.value * 50}px`;
        joystickArea.style.left = `${joystickXSlider.value}%`;
        joystickArea.style.bottom = `${100 - joystickYSlider.value}%`;
        btnAction.parentNode.style.right = `${100 - btnXSlider.value}%`;
        btnAction.parentNode.style.bottom = `${100 - btnYSlider.value}%`;
    }
    
    hudSizeSlider.addEventListener('input', applyGameOptions);
    btnSizeSlider.addEventListener('input', applyGameOptions);
    joystickSizeSlider.addEventListener('input', applyGameOptions);
    joystickXSlider.addEventListener('input', applyGameOptions);
    joystickYSlider.addEventListener('input', applyGameOptions);
    btnXSlider.addEventListener('input', applyGameOptions);
    btnYSlider.addEventListener('input', applyGameOptions);
    
    // Inicia com as configura√ß√µes padr√£o
    applyGameOptions();

    function updateInventory() {
        const invDiv = document.getElementById('inv');
        let txt = `<span style="font-size: 14px;">üå≤: ${inventory.madeira} | ü™®: ${inventory.pedra} | üçé: ${inventory.maca} | üèπ: ${inventory.flechas} | üíé: ${inventory.gema} | üß™: ${inventory.pocao}</span>`;
        invDiv.innerHTML = txt;
        renderHotbar();
    }
    
    function updateCrafting() {
      const craftDiv = document.getElementById('craft');
      let txt = `<b>Constru√ß√£o:</b> `;
      const item = hotbarItens[hotbarSelecionado].id;
      if (item === buildMode) {
          txt += `${hotbarItens.find(i=>i.id===item).emoji} ${hotbarItens.find(i=>i.id===item).nome}`;
      } else {
          txt += '<span style="color:#aaa">Nenhum</span>';
      }
      craftDiv.innerHTML = txt;
    }

    function updateVida() {
      let hearts = '';
      for (let i = 0; i < Math.floor(player.vida); i++) hearts += '‚ù§Ô∏è';
      if (player.vida % 1 >= 0.5) hearts += 'üíî';
      vidaSpan.innerHTML = hearts;
      armaduraSpan.innerHTML = inventory.armadura ? 'ü¶∫' : '';
    }

    function craftSelectedItem() {
      playSound('click');
      const item = hotbarItens[hotbarSelecionado].id;
      if (item === 'espada' && !inventory.espada && inventory.madeira >= 3 && inventory.pedra >= 2) {
        inventory.madeira -= 3; inventory.pedra -= 2; inventory.espada = true; updateInventory();
      }
      if (item === 'picareta' && !inventory.picareta && inventory.madeira >= 2 && inventory.pedra >= 3) {
        inventory.madeira -= 2; inventory.pedra -= 3; inventory.picareta = true; updateInventory();
      }
      if (item === 'arco' && !inventory.arco && inventory.madeira >= 4) {
        inventory.madeira -= 4; inventory.arco = true; updateInventory();
      }
      if (item === 'tocha' && inventory.madeira >= 1 && inventory.pedra >= 1) {
        inventory.madeira -= 1; inventory.pedra -= 1; inventory.tocha += 1; updateInventory();
      }
      if (item === 'fogueira' && inventory.madeira >= 5) {
        inventory.madeira -= 5; inventory.fogueira += 1; updateInventory();
      }
      if (item === 'parede_madeira' && inventory.madeira >= 2) {
        inventory.madeira -= 2; inventory.parede_madeira += 1; updateInventory();
      }
      if (item === 'parede_pedra' && inventory.pedra >= 2) {
        inventory.pedra -= 2; inventory.parede_pedra += 1; updateInventory();
      }
      if (item === 'armadilha' && inventory.madeira >= 1 && inventory.pedra >= 1) {
        inventory.madeira -= 1; inventory.pedra -= 1; inventory.armadilha += 1; updateInventory();
      }
      if (item === 'mina' && inventory.mina > 0) {
        inventory.mina--; updateInventory();
      }
      if (item === 'maca' && inventory.madeira >= 2 && inventory.pedra >= 1) {
        inventory.madeira -= 2; inventory.pedra -= 1; inventory.maca += 1; updateInventory();
      }
      if (item === 'armadura' && !inventory.armadura && inventory.pedra >= 4 && inventory.madeira >= 2) {
        inventory.pedra -= 4; inventory.madeira -= 2;
        inventory.armadura = true; player.armadura = true; updateInventory(); updateVida();
      }
      if (item === 'superpicareta' && !inventory.superpicareta && inventory.gema >= 5) {
        inventory.gema -= 5; inventory.superpicareta = true; updateInventory();
      }
      if (item === 'tinteiro_magico' && inventory.gema >= 10) {
        inventory.gema -= 10; inventory.tinteiro_magico++; updateInventory();
      }
      if (item === 'pocao' && inventory.gema >= 3 && inventory.pedra >= 5) {
          inventory.gema -= 3; inventory.pedra -= 5; inventory.pocao++; updateInventory();
      }
    }

    function usarHotbarAtMouse() {
      const item = hotbarItens[hotbarSelecionado].id;
      if (item === 'espada') {
        attackEnemy();
      } else if (item === 'arco') {
        shootArrow();
      } else if (item === 'maca') {
        usarMaca();
      } else if (item === 'tinteiro_magico') {
        usarTinteiroMagico();
      } else if (item === 'pocao') {
        usarPocao();
      } else if (item === 'tocha' || item === 'parede_madeira' || item === 'parede_pedra' || item === 'armadilha' || item === 'mina' || item === 'fogueira') {
        buildMode = item;
        updateCrafting();
      } else if (item === 'picareta' || item === 'superpicareta') {
        usePickaxeAt(mouseWorld.x, mouseWorld.y);
      }
    }
    
    function usarMaca() {
      if (inventory.maca > 0 && player.vida < 5) {
        playSound('collect');
        inventory.maca--; player.vida = Math.min(5, player.vida + 2); updateInventory(); updateVida();
      }
    }

    function usarTinteiroMagico() {
        if (inventory.tinteiro_magico > 0) {
            playSound('collect');
            const newColor = prompt("Digite um c√≥digo de cor (ex: #ff0000, blue):", player.color);
            if (newColor) {
                player.color = newColor;
                inventory.tinteiro_magico--;
                updateInventory();
            }
        }
    }

    function usarPocao() {
        if (inventory.pocao > 0) {
            playSound('potion');
            player.speedModifier = 2;
            player.defenseModifier = 0.5;
            player.attackModifier = 2;
            player.effectTimer = 30; // 30 segundos
            inventory.pocao--;
            updateInventory();
        }
    }
    
    function attackEnemy() {
      if (!inventory.espada) return;
      playSound('attack');
      const attackPower = inventory.espada ? 1 : 0;
      for (let e of enemies) {
        if (!e.alive) continue;
        const dx = player.x + player.size/2 - (e.x + e.size/2);
        const dy = player.y + player.size/2 - (e.y + e.size/2);
        const dist = Math.hypot(dx, dy);
        if (dist < 54) { e.vida -= attackPower * player.attackModifier; if (e.vida <= 0) e.alive = false; return; }
      }
    }

    function shootArrow() {
      if (!inventory.arco || inventory.flechas <= 0) return;
      playSound('bow');
      inventory.flechas--;
      const dx = mouseWorld.x - player.x;
      const dy = mouseWorld.y - player.y;
      const angle = Math.atan2(dy, dx);
      const speed = 15;
      arrows.push({
          x: player.x,
          y: player.y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed
      });
      updateInventory();
    }
    
    function usePickaxeAt(x, y) {
      if (!inventory.picareta && !inventory.superpicareta) return;
      playSound('attack');
      const radius = inventory.superpicareta ? 120 : 48;
      for (let i = materials.length-1; i >= 0; i--) {
        const m = materials[i];
        const dx = (m.x + m.size/2) - x;
        const dy = (m.y + m.size/2) - y;
        if (Math.hypot(dx,dy) <= radius) {
          if (m.type === 'madeira') inventory.madeira++;
          else if (m.type === 'pedra') inventory.pedra++;
          else if (m.type === 'madeira_floresta') inventory.madeira_floresta++;
          else if (m.type === 'gema') inventory.gema++;
          m.x = -100;
        }
      }
      for (let i = buildings.length-1; i >= 0; i--) {
        const b = buildings[i];
        const bx = b.x + b.size/2, by = b.y + b.size/2;
        if (Math.hypot(bx-x, by-y) <= radius) {
          if (b.type === 'parede_madeira') inventory.madeira += 1;
          if (b.type === 'parede_pedra') inventory.pedra += 2;
          buildings.splice(i,1);
        }
      }
      updateInventory();
      renderHotbar();
    }
    
    function buildAt(x, y) {
      if (!buildMode) return;
      
      let item = hotbarItens[hotbarSelecionado].id;
      if (item === 'tocha' && inventory.tocha > 0) {
        playSound('click');
        torches.push({ x: x-12, y: y-12, size: 24 }); inventory.tocha--; updateInventory();
        buildMode = null;
      } else if (item === 'parede_madeira' && inventory.parede_madeira > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'parede_madeira' });
        inventory.parede_madeira--; updateInventory();
        buildMode = null;
      } else if (item === 'parede_pedra' && inventory.parede_pedra > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'parede_pedra' });
        inventory.parede_pedra--; updateInventory();
        buildMode = null;
      } else if (item === 'armadilha' && inventory.armadilha > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'armadilha' });
        inventory.armadilha--; updateInventory();
        buildMode = null;
      } else if (item === 'mina' && inventory.mina > 0) {
        playSound('click');
        bombs.push({ x: x-12, y: y-12, size: 24, timer: 900 }); inventory.mina--; updateInventory();
        buildMode = null;
      } else if (item === 'fogueira' && inventory.fogueira > 0) {
        playSound('click');
        buildings.push({ x: x-20, y: y-20, size: 40, type: 'fogueira' });
        inventory.fogueira--; updateInventory();
        buildMode = null;
      } else {
        buildMode = null;
      }
      updateCrafting();
    }
    
    function spawnEnemy() {
      const edge = Math.floor(Math.random() * 4);
      let x, y;
      if (edge === 0) { x = 0; y = Math.random() * MAPA_ALTURA; }
      else if (edge === 1) { x = MAPA_LARGURA; y = Math.random() * MAPA_ALTURA; }
      else if (edge === 2) { x = Math.random() * MAPA_LARGURA; y = 0; }
      else { x = Math.random() * MAPA_LARGURA; y = MAPA_ALTURA; }
      let tipo = 'normal', cor = 'red', vida = 1, speed = 1.2 + Math.random(), dano = 1;
      if (dias >= 10 && Math.random() < 0.2) { tipo = 'rapido'; cor = '#ff9800'; speed = 2.5 + Math.random(); }
      if (dias >= 25 && Math.random() < 0.15) { tipo = 'tanque'; cor = '#607d8b'; vida = 3; speed = 0.7 + Math.random()*0.5; dano = 2; }
      if (dias >= 100 && Math.random() < 0.1) { tipo = 'fantasma'; cor = '#b39ddb'; vida = 2; speed = 1.7 + Math.random(); dano = 2; }
      if (dias >= 200 && Math.random() < 0.07) { tipo = 'explosivo'; cor = '#fff176'; vida = 1; speed = 1.3 + Math.random(); dano = 3; }
      enemies.push({ x, y, size: 36, speed, alive: true, mood: Math.random(), tipo, cor, vida, dano, explodindo: false });
    }
    
    function spawnMaterials() {
      materials = [];
      const spawnChance = isDay ? 0.05 : 0.02; // Gems s√£o mais raras √† noite
      for (let i = 0; i < 12; i++) {
        materials.push({ x: Math.random() * (MAPA_LARGURA-60), y: Math.random() * (MAPA_ALTURA-60), size: 32, type: 'madeira' });
      }
      for (let i = 0; i < 9; i++) {
        materials.push({ x: Math.random() * (MAPA_LARGURA-60), y: Math.random() * (MAPA_ALTURA-60), size: 28, type: 'pedra' });
        if(Math.random() < spawnChance) {
          materials.push({ x: Math.random() * (MAPA_LARGURA-60), y: Math.random() * (MAPA_ALTURA-60), size: 26, type: 'gema' });
        }
      }
      if (florestaDesbloqueada) {
        for (let i = 0; i < 20; i++) {
          materials.push({
            x: MAPA_LARGURA * 0.45 + Math.random() * (MAPA_LARGURA - MAPA_LARGURA * 0.45 - 160),
            y: 60 + Math.random() * (MAPA_ALTURA - 120),
            size: 36,
            type: Math.random() < 0.85 ? 'madeira_floresta' : 'madeira'
          });
        }
      }
      apples = Math.random() < 0.6 ? [{ x: Math.random() * (MAPA_LARGURA-60), y: Math.random() * (MAPA_ALTURA-60), size: 24, collected: false }] : [];
    }
    
    function movePlayer() {
      let vel = player.baseSpeed * player.speedModifier;
      let moved = false;
      if (florestaDesbloqueada && player.x > MAPA_LARGURA * 0.4) vel = player.baseSpeed * 0.55 * player.speedModifier;
      if (keyboard['arrowup'] || keyboard['w']) { player.y -= vel; moved = true; }
      if (keyboard['arrowdown'] || keyboard['s']) { player.y += vel; moved = true; }
      if (keyboard['arrowleft'] || keyboard['a']) { player.x -= vel; moved = true; }
      if (keyboard['arrowright'] || keyboard['d']) { player.x += vel; moved = true; }
      if (!montanhaLiberada && player.x > MAPA_LARGURA - 200) player.x = MAPA_LARGURA - 200;
      if (player.x < 0) player.x = 0;
      if (player.x > MAPA_LARGURA - player.size) player.x = MAPA_LARGURA - player.size;
      if (player.y < 0) player.y = 0;
      if (player.y > MAPA_ALTURA - player.size) player.y = MAPA_ALTURA - player.size;
      if (moved && Math.floor(performance.now() / 150) % 2 === 0) playSound('step');
      return moved;
    }
    
    function updateCamera() {
      // Ajuste imediato da c√¢mera para o centro do jogador
      camera.x = player.x + player.size / 2 - W() / (2 * CAMERA_ZOOM);
      camera.y = player.y + player.size / 2 - H() / (2 * CAMERA_ZOOM);
      
      const visibleWidth = W() / CAMERA_ZOOM;
      const visibleHeight = H() / CAMERA_ZOOM;
      
      camera.x = Math.max(0, Math.min(MAPA_LARGURA - visibleWidth, camera.x));
      camera.y = Math.max(0, Math.min(MAPA_ALTURA - visibleHeight, camera.y));
    }
    
    function moveEnemies() {
      for (let e of enemies) {
        if (!e.alive) continue;
        let blocked = false;
        if (e.tipo !== 'fantasma') {
          for (let b of buildings) {
            if (e.x < b.x + b.size && e.x + e.size > b.x && e.y < b.y + b.size && e.y + e.size > b.y) { blocked = true; break; }
          }
        }
        if (blocked) continue;
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.hypot(dx, dy) || 1;
        e.x += (dx / dist) * e.speed;
        e.y += (dy / dist) * e.speed;
      }
    }
    
    function checkCollision() {
      for (let m of materials) {
        if (m.x < 0) continue;
        if (player.x < m.x + m.size && player.x + player.size > m.x && player.y < m.y + m.size && player.y + m.size > m.y) {
          playSound('collect');
          if (m.type === 'madeira') inventory.madeira++;
          if (m.type === 'pedra') inventory.pedra++;
          if (m.type === 'madeira_floresta') inventory.madeira_floresta++;
          if (m.type === 'gema') inventory.gema++;
          m.x = -100;
          updateInventory();
        }
      }
      for (let a of apples) {
        if (a.collected) continue;
        if (player.x < a.x + a.size && player.x + player.size > a.x && player.y < a.y + a.size && player.y + a.size > a.y) {
          playSound('collect');
          inventory.maca++; a.collected = true; updateInventory();
        }
      }
      for (let e of enemies) {
        if (!e.alive) continue;
        if (player.x < e.x + e.size && player.x + player.size > e.x && player.y < e.y + e.size && player.y + player.size > e.y) {
          if (player.invencivel > 0) continue;
          playSound('damage');
          if (e.tipo === 'explosivo' && !e.explodindo) {
            e.explodindo = true;
            setTimeout(()=>{
              if (!running) return;
              playSound('explosion');
              player.vida -= e.dano*player.defenseModifier;
              updateVida();
              e.alive = false;
              if (player.vida <= 0) { running = false; restartBtn.style.display = 'inline'; }
            }, 300);
          } else {
            let damage = e.dano * player.defenseModifier;
            if (inventory.armadura) damage *= 0.5;
            player.vida -= damage;
            player.invencivel = 40;
            updateVida();
            if (player.vida <= 0) { running = false; restartBtn.style.display = 'inline'; }
          }
        }
      }
    }
    
    function drawBackground(now) {
      ctx.save();
      const t = (now / 2000) % 1;
      const grad = ctx.createLinearGradient(0, 0, W(), H());
      grad.addColorStop(0, isDay ? "#b6e07a" : "#2b3c5e");
      grad.addColorStop(0.5 + t / 2, isDay ? "#6bbf3c" : "#1a1e3e");
      grad.addColorStop(1, isDay ? "#a2e0e6" : "#223c16");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W(), H());
      for (const p of particles) {
        ctx.globalAlpha = 1;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fillStyle = p.color;
        ctx.fill();
        p.x += p.dx;
        p.y += p.dy;
        if (p.x < -p.r) p.x = W() + p.r;
        if (p.x > W() + p.r) p.x = -p.r;
        if (p.y < -p.r) p.y = H() + p.r;
        if (p.y > H() + p.r) p.y = -p.r;
      }
      ctx.restore();
    }
    
    function drawWorld(now) {
      if (!ctx) return;
      
      ctx.save();
      ctx.fillStyle = '#6a6a6a';
      ctx.fillRect(MAPA_LARGURA - 200, 0, 200, MAPA_ALTURA);
      ctx.fillStyle = '#444';
      ctx.fillRect(MAPA_LARGURA - 200, 0, 20, MAPA_ALTURA);
      ctx.restore();
      
      if (florestaDesbloqueada) {
        ctx.save();
        ctx.fillStyle = '#006400';
        ctx.fillRect(MAPA_LARGURA * 0.45, 0, MAPA_LARGURA * 0.55, MAPA_ALTURA);
        ctx.restore();
      }
      
      if (montanhaLiberada) {
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.fillStyle = "#b0bec5";
        ctx.beginPath();
        ctx.moveTo(MAPA_LARGURA-200, MAPA_ALTURA);
        ctx.lineTo(MAPA_LARGURA-100, MAPA_ALTURA/2);
        ctx.lineTo(MAPA_LARGURA, MAPA_ALTURA/2+100);
        ctx.lineTo(MAPA_LARGURA, MAPA_ALTURA);
        ctx.closePath();
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.restore();
        ctx.save();
        ctx.fillStyle = "#fff";
        ctx.globalAlpha = 0.3;
        ctx.beginPath();
        ctx.moveTo(MAPA_LARGURA-100, MAPA_ALTURA/2);
        ctx.lineTo(MAPA_LARGURA-60, MAPA_ALTURA/2+40);
        ctx.lineTo(MAPA_LARGURA-20, MAPA_ALTURA/2+20);
        ctx.lineTo(MAPA_LARGURA, MAPA_ALTURA/2+100);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }
    
      for (let m of materials) {
        if (m.x < 0) continue;
        if (m.type === 'madeira' || m.type === 'madeira_floresta') {
          ctx.save();
          ctx.shadowColor = "#5a2d0c";
          ctx.shadowBlur = 10;
          ctx.fillStyle = m.type === 'madeira' ? "#8B4513" : "#6A4E1A";
          ctx.beginPath();
          ctx.arc(m.x+m.size/2, m.y+m.size/2, m.size/2, 0, 2*Math.PI);
          ctx.fill();
          ctx.shadowBlur = 0;
          ctx.strokeStyle = "#deb887";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(m.x+m.size/2, m.y+m.size/2, m.size/4, 0, 2*Math.PI);
          ctx.stroke();
          ctx.fillStyle = m.type === 'madeira' ? "#4caf50" : "#2e7d32";
          ctx.beginPath();
          ctx.arc(m.x+m.size/2+8, m.y+m.size/2-10, 7, 0, 2*Math.PI);
          ctx.fill();
          ctx.restore();
        } else if (m.type === 'pedra') {
          ctx.save();
          ctx.shadowColor = "#fff";
          ctx.shadowBlur = 8;
          ctx.fillStyle = "#bbb";
          ctx.beginPath();
          ctx.ellipse(m.x+m.size/2, m.y+m.size/2, m.size/2, m.size/2.5, 0.3, 0, 2*Math.PI);
          ctx.fill();
          ctx.shadowBlur = 0;
          ctx.fillStyle = "#fff8";
          ctx.beginPath();
          ctx.arc(m.x+m.size/2+5, m.y+m.size/2-5, 5, 0, 2*Math.PI);
          ctx.fill();
          ctx.restore();
        } else if (m.type === 'gema') {
          ctx.save();
          ctx.shadowColor = "#00e";
          ctx.shadowBlur = 16;
          ctx.fillStyle = "#00e6ff";
          ctx.beginPath();
          ctx.moveTo(m.x+m.size/2, m.y);
          ctx.lineTo(m.x+m.size, m.y+m.size/2);
          ctx.lineTo(m.x+m.size/2, m.y+m.size);
          ctx.lineTo(m.x, m.y+m.size/2);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }
      }
    
      for (let a of apples) {
        if (a.collected) continue;
        ctx.save();
        ctx.shadowColor = "#f00";
        ctx.shadowBlur = 10;
        ctx.fillStyle = "#e53935";
        ctx.beginPath();
        ctx.arc(a.x+a.size/2, a.y+a.size/2, a.size/2, 0, 2*Math.PI);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#fff8";
        ctx.beginPath();
        ctx.arc(a.x+a.size/2+3, a.y+a.size/2-5, 4, 0, 2*Math.PI);
        ctx.fill();
        ctx.strokeStyle = "#795548";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(a.x+a.size/2, a.y+a.size/2-8);
        ctx.lineTo(a.x+a.size/2, a.y+a.size/2-14);
        ctx.stroke();
        ctx.restore();
      }
    
      for (let b of buildings) {
        if (b.type === 'parede_madeira') {
          ctx.save();
          ctx.shadowColor = "#deb887";
          ctx.shadowBlur = 8;
          ctx.fillStyle = "#deb887";
          ctx.strokeStyle = "#8B4513";
          ctx.lineWidth = 3;
          ctx.fillRect(b.x, b.y, b.size, b.size);
          ctx.strokeRect(b.x, b.y, b.size, b.size);
          ctx.beginPath();
          ctx.moveTo(b.x+8, b.y+b.size-8); ctx.lineTo(b.x+b.size-8, b.y+8);
          ctx.stroke();
          ctx.restore();
        } else if (b.type === 'parede_pedra') {
          ctx.save();
          ctx.shadowColor = "#555";
          ctx.shadowBlur = 8;
          ctx.fillStyle = "#607d8b";
          ctx.strokeStyle = "#455a64";
          ctx.lineWidth = 3;
          ctx.fillRect(b.x, b.y, b.size, b.size);
          ctx.strokeRect(b.x, b.y, b.size, b.size);
          ctx.beginPath();
          ctx.moveTo(b.x+8, b.y+8); ctx.lineTo(b.x+b.size-8, b.y+8);
          ctx.lineTo(b.x+b.size-8, b.y+b.size-8);
          ctx.lineTo(b.x+8, b.y+b.size-8);
          ctx.closePath();
          ctx.stroke();
          ctx.restore();
        } else if (b.type === 'armadilha') {
          ctx.save();
          ctx.shadowColor = "#555";
          ctx.shadowBlur = 8;
          ctx.fillStyle = "#555";
          ctx.strokeStyle = "#333";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(b.x+b.size/2, b.y+b.size/2, b.size/2, 0, 2*Math.PI);
          ctx.fill();
          ctx.beginPath();
          ctx.moveTo(b.x,b.y); ctx.lineTo(b.x+b.size,b.y+b.size);
          ctx.moveTo(b.x+b.size,b.y); ctx.lineTo(b.x,b.y+b.size);
          ctx.stroke();
          ctx.restore();
        } else if (b.type === 'fogueira') {
            ctx.save();
            ctx.shadowColor = "#ff5722";
            ctx.shadowBlur = 12;
            ctx.fillStyle = '#ff5722';
            ctx.beginPath();
            ctx.moveTo(b.x+15,b.y+b.size);
            ctx.lineTo(b.x+25,b.y+b.size);
            ctx.lineTo(b.x+20, b.y+b.size-20);
            ctx.fill();
            ctx.fillStyle = '#ff9800';
            ctx.beginPath();
            ctx.moveTo(b.x+18,b.y+b.size-5);
            ctx.lineTo(b.x+28,b.y+b.size-5);
            ctx.lineTo(b.x+23,b.y+b.size-25);
            ctx.fill();
            ctx.restore();
        }
      }
    
      for (let t of torches) {
        ctx.save();
        ctx.shadowColor = "#ff0";
        ctx.shadowBlur = 24;
        ctx.fillStyle = "#ff0";
        ctx.beginPath();
        ctx.arc(t.x+12, t.y+12, 12, 0, 2*Math.PI);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = "#b8860b";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(t.x+12, t.y+12);
        ctx.lineTo(t.x+12, t.y+26);
        ctx.stroke();
        ctx.restore();
      }
    
      for (let b of bombs) {
        ctx.save();
        ctx.fillStyle = '#222';
        ctx.fillRect(b.x, b.y, b.size, b.size);
        ctx.fillStyle = '#f33';
        ctx.fillRect(b.x+6, b.y+6, b.size-12, 6);
        ctx.restore();
      }

      for (let a of arrows) {
        ctx.save();
        ctx.fillStyle = '#fff';
        ctx.fillRect(a.x, a.y, 10, 2);
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(a.x + 10, a.y - 5);
        ctx.lineTo(a.x + 15, a.y);
        ctx.lineTo(a.x + 10, a.y + 5);
        ctx.fill();
        ctx.restore();
      }
    
      if (player) {
          drawPlayerEntity(player);
      }
      
      for(const id in otherPlayers) {
          drawPlayerEntity(otherPlayers[id]);
      }
    
      for (let e of enemies) {
        if (!e.alive) continue;
        ctx.save();
        ctx.translate(e.x+e.size/2, e.y+e.size/2);
        ctx.shadowColor = e.cor;
        ctx.shadowBlur = 16;
        ctx.fillStyle = e.cor;
        ctx.beginPath();
        ctx.arc(0, 0, e.size/2, 0, 2*Math.PI);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.ellipse(-7, -6, 5, 4, 0, 0, 2*Math.PI);
        ctx.ellipse(7, -6, 5, 4, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.fillStyle = "#900";
        ctx.beginPath();
        ctx.ellipse(-7, -6, 2, 2, 0, 0, 2*Math.PI);
        ctx.ellipse(7, -6, 2, 2, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.strokeStyle = "#900";
        ctx.lineWidth = 2;
        ctx.beginPath();
        if (e.tipo === 'tanque') ctx.arc(0, 15, 8, Math.PI, 2*Math.PI);
        else if (e.tipo === 'rapido') ctx.arc(0, 7, 8, 0, Math.PI);
        else if (e.tipo === 'explosivo') ctx.arc(0, 0, 12, 0, 2*Math.PI);
        else ctx.arc(0, 7, 8, 0.2, Math.PI-0.2);
        ctx.stroke();
        ctx.restore();
      }
      ctx.restore();
    }
    
    function drawPlayerEntity(ent) {
      if (!ctx || !ent) return;
      ctx.save();
      ctx.translate(ent.x+ent.size/2, ent.y+ent.size/2);
      ctx.shadowColor = ent.color;
      ctx.shadowBlur = 18;
      ctx.globalAlpha = ent.invencivel > 0 ? 0.5 : 1;
      ctx.fillStyle = ent.color;
      ctx.beginPath();
      ctx.arc(0, 0, ent.size/2, 0, 2*Math.PI);
      ctx.fill();
      ctx.shadowBlur = 0;
      if (ent.armadura) {
        ctx.strokeStyle = "#b0c4de";
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.arc(0, 0, ent.size/2-2, Math.PI*0.15, Math.PI*0.85);
        ctx.stroke();
      }
      let blink = Math.abs(Math.sin(Date.now()/600 + ent.x/50));
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.ellipse(-9, -7, 6, 5*blink, 0, 0, 2*Math.PI);
      ctx.ellipse(9, -7, 6, 5*blink, 0, 0, 2*Math.PI);
      ctx.fill();
      ctx.fillStyle = "#222";
      ctx.beginPath();
      ctx.ellipse(-9, -7, 2, 2*blink, 0, 0, 2*Math.PI);
      ctx.ellipse(9, -7, 2, 2*blink, 0, 0, 2*Math.PI);
      ctx.fill();
      ctx.strokeStyle = "#222";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(0, 7, 10, 0.2, Math.PI-0.2);
      ctx.stroke();
      ctx.restore();
    
      if (ent.espada) {
        ctx.save();
        ctx.translate(ent.x+ent.size, ent.y+ent.size/2);
        ctx.rotate(-0.2);
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, -5, 22, 10);
        ctx.strokeStyle = "#aaa";
        ctx.lineWidth = 2;
        ctx.strokeRect(0, -5, 22, 10);
        ctx.restore();
      }
      if (ent.picareta) {
        ctx.save();
        ctx.translate(ent.x-10, ent.y+ent.size/2);
        ctx.fillStyle = '#888';
        ctx.fillRect(0, -4, 16, 8);
        ctx.fillRect(7, -12, 5, 18);
        ctx.restore();
      }
      if (ent.superpicareta) {
        ctx.save();
        ctx.translate(ent.x-18, ent.y+ent.size/2-18);
        ctx.fillStyle = '#0ff';
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(0,0); ctx.lineTo(30,10); ctx.lineTo(10,30); ctx.closePath();
        ctx.fill();
        ctx.stroke();
        ctx.restore();
      }
      if (ent.arco) {
        ctx.save();
        ctx.translate(ent.x+ent.size/2, ent.y+ent.size/2);
        ctx.strokeStyle = '#a4a4a4';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(0, 0, 25, 0, Math.PI);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(-25, 0);
        ctx.lineTo(25, 0);
        ctx.stroke();
        ctx.restore();
      }
    }
    
    function gameLoop(now) {
      if (!ctx) {
        console.warn("Canvas context not initialized. Retrying...");
        setTimeout(() => requestAnimationFrame(gameLoop), 100);
        return;
      }

      if (!startTime) startTime = now;
      if (running && !paused) {
        elapsed = (now - startTime) / 1000;
        timerSpan.textContent = elapsed.toFixed(1);
        dias = Math.floor(elapsed / (dayLength*2)) + 1;
        if (dias !== lastDay) { lastDay = dias; }
        diasSpan.textContent = "Dia " + dias;
        if (!florestaDesbloqueada && dias >= 15) {
          florestaDesbloqueada = true;
          spawnMaterials();
        }
        if (!montanhaLiberada && dias >= 1000) montanhaLiberada = true;
        isDay = Math.floor(elapsed / dayLength) % 2 === 0;

        if (player.effectTimer > 0) {
            player.effectTimer -= 1/60;
            if (player.effectTimer <= 0) {
                player.speedModifier = 1;
                player.defenseModifier = 1;
                player.attackModifier = 1;
            }
        }
        
        movePlayer();
        updateCamera();
        moveEnemies();
        checkCollision();
        
        if (isMultiplayerEnabled && ws && ws.readyState === WebSocket.OPEN) {
            sendPlayerUpdate();
        }
        
        for (let i = bombs.length-1; i >= 0; i--) {
          const b = bombs[i];
          b.timer -= (1000/60);
          if (b.timer <= 0) {
            playSound('explosion');
            const ex = b.x + b.size/2, ey = b.y + b.size/2;
            const r = 120;
            for (let j = enemies.length-1; j >= 0; j--) {
              const e = enemies[j];
              if (!e.alive) continue;
              if (Math.hypot(e.x+e.size/2-ex, e.y+e.size/2-ey) <= r) { e.alive = false; }
            }
            for (let j = materials.length-1; j >= 0; j--) {
              const m = materials[j];
              if (Math.hypot(m.x+m.size/2-ex, m.y+m.size/2-ey) <= r) m.x = -100;
            }
            for (let j = buildings.length-1; j >= 0; j--) {
              const bld = buildings[j];
              if (Math.hypot(bld.x+bld.size/2-ex, bld.y+bld.size/2-ey) <= r) buildings.splice(j,1);
            }
            if (Math.hypot(player.x+player.size/2-ex, player.y+player.size/2-ey) <= r) {
              player.vida -= 2 * player.defenseModifier; updateVida();
              if (player.vida <= 0) { running = false; restartBtn.style.display = 'inline'; }
            }
            bombs.splice(i,1);
          }
        }

        for (let i = arrows.length - 1; i >= 0; i--) {
            const arrow = arrows[i];
            arrow.x += arrow.vx;
            arrow.y += arrow.vy;
            let hit = false;
            for (let j = enemies.length - 1; j >= 0; j--) {
                const enemy = enemies[j];
                if (Math.hypot(arrow.x - enemy.x, arrow.y - enemy.y) < 20) {
                    enemy.vida -= 1 * player.attackModifier;
                    if (enemy.vida <= 0) {
                        enemy.alive = false;
                    }
                    hit = true;
                    break;
                }
            }
            if (hit || arrow.x < -100 || arrow.x > MAPA_LARGURA + 100 || arrow.y < -100 || arrow.y > MAPA_ALTURA + 100) {
                arrows.splice(i, 1);
            }
        }
    
        drawBackground(now);
        
        ctx.save();
        ctx.scale(CAMERA_ZOOM, CAMERA_ZOOM);
        ctx.translate(-camera.x, -camera.y);
        drawWorld(now);
        ctx.restore();
    
        if (player.invencivel > 0) player.invencivel--;
        if (!isDay && Math.floor(elapsed * 10) % 15 === 0 && enemies.length < Math.floor(elapsed / 2) + 2) spawnEnemy();
        if (Math.floor(elapsed) % 14 === 0 && Math.floor(elapsed) !== 0 && Math.floor(elapsed * 10) % 10 === 0) spawnMaterials();
    
        requestAnimationFrame(gameLoop);
      } else if (!running) {
        timerSpan.textContent = elapsed.toFixed(1);
        ctx.save();
        ctx.globalAlpha = 0.85;
        ctx.fillStyle = '#222b';
        ctx.fillRect(W()/2-180, H()/2-80, 360, 160);
        ctx.globalAlpha = 1;
        ctx.fillStyle = 'white';
        ctx.font = '38px Arial';
        ctx.textAlign = "center";
        ctx.fillText('Game Over!', W()/2, H()/2-10);
        ctx.font = '24px Arial';
        ctx.fillText('Tempo: ' + elapsed.toFixed(1) + ' s', W()/2, H()/2+30);
        ctx.restore();
        if (currentMusic) { currentMusic.pause(); }
      }
      if (paused) {
        drawBackground(now);
        ctx.save();
        ctx.scale(CAMERA_ZOOM, CAMERA_ZOOM);
        ctx.translate(-camera.x, -camera.y);
        drawWorld(now);
        ctx.restore();
        requestAnimationFrame(gameLoop);
      }
    }

    window.onload = () => { 
      gameContainer.style.display = 'none';
      startMenu.style.display = 'flex';
      initCanvas();
    };
    restartBtn.onclick = resetGame;
  </script>
</body>
</html>